<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNICORN Shop - Магазин одежды и обуви</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Все стили остаются без изменений */
        :root {
            --primary: #8A2BE2;
            --primary-light: #9D4EDD;
            --secondary: #FF6B6B;
            --accent: #FFD166;
            --success: #4CAF50;
            --warning: #FF9800;
            --info: #2196F3;
            --dark: #1A1A1A;
            --light: #F8F9FA;
            --gray: #6C757D;
            --light-gray: #E9ECEF;
            --border: #DEE2E6;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            background: white;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: white;
            color: var(--dark);
            line-height: 1.5;
            position: relative;
            overscroll-behavior: none;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 720px;
                padding: 0 20px;
            }
        }

        @media (min-width: 992px) {
            .container {
                max-width: 960px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            height: 60px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding: 0 15px;
            gap: 10px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            flex-shrink: 0;
        }

        .logo-icon {
            font-size: 22px;
            color: var(--primary);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }

        .search-container {
            flex: 1;
            max-width: 100%;
            position: relative;
        }

        @media (max-width: 480px) {
            .search-container {
                display: none;
            }
        }

        .search {
            width: 100%;
            padding: 10px 15px;
            padding-left: 40px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            background: var(--light);
            -webkit-appearance: none;
        }

        .search:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .action-btn {
            position: relative;
            background: none;
            border: none;
            color: var(--dark);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .action-btn:active {
            background: var(--light);
            transform: scale(0.95);
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--secondary);
            color: white;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 20px;
            transition: background 0.2s ease;
        }

        .user-menu:active {
            background: var(--light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        /* Main Navigation */
        .main-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border);
            z-index: 1000;
            height: 65px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .nav-container {
            display: flex;
            height: 100%;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 10px;
            gap: 4px;
            padding: 8px 0;
            transition: color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item i {
            font-size: 18px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:active {
            opacity: 0.7;
        }

        /* Main Content */
        .main-content {
            padding: 70px 0 75px;
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            background: white;
        }

        /* Admin Toggle Button */
        .admin-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 9999;
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }

        .admin-toggle:active {
            transform: scale(0.95);
        }

        /* Banner */
        .banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .banner-content {
            position: relative;
            z-index: 2;
        }

        .banner-badge {
            display: inline-block;
            background: var(--secondary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .banner-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .banner-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .banner-unicorn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 60px;
            opacity: 0.2;
        }

        @media (max-width: 350px) {
            .banner-unicorn {
                display: none;
            }
        }

        /* Categories */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
            width: 100%;
        }

        @media (min-width: 480px) {
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 768px) {
            .categories-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
            }
        }

        .category-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
            aspect-ratio: 1;
            transition: transform 0.2s ease;
            width: 100%;
        }

        .category-card:active {
            transform: scale(0.98);
        }

        .category-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .category-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 12px;
            color: white;
        }

        .category-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .category-count {
            font-size: 11px;
            opacity: 0.9;
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 30px;
            width: 100%;
        }

        @media (min-width: 480px) {
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
        }

        @media (min-width: 992px) {
            .products-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .product-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
            position: relative;
            width: 100%;
            cursor: pointer;
        }

        .product-card:active {
            transform: scale(0.98);
        }

        .product-image-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            background: var(--light-gray);
            overflow: hidden;
        }

        .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            color: var(--gray);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .wishlist-btn:active {
            transform: scale(0.9);
        }

        .wishlist-btn.active {
            color: var(--secondary);
        }

        .product-content {
            padding: 12px;
        }

        .product-brand {
            font-size: 11px;
            color: var(--gray);
            margin-bottom: 4px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            height: 36px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .current-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }

        .old-price {
            font-size: 12px;
            color: var(--gray);
            text-decoration: line-through;
        }

        .discount {
            color: var(--secondary);
            font-size: 11px;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .add-to-cart {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s ease;
            -webkit-appearance: none;
        }

        .add-to-cart:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .add-to-cart.added {
            background: var(--success);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            width: 100%;
        }

        .empty-icon {
            font-size: 48px;
            color: var(--light-gray);
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .empty-text {
            color: var(--gray);
            margin-bottom: 24px;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Profile Page */
        .profile-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            margin: -15px -15px 20px;
            border-radius: 0 0 var(--radius) var(--radius);
            width: calc(100% + 30px);
        }

        @media (min-width: 768px) {
            .profile-header {
                margin: -20px -20px 20px;
                width: calc(100% + 40px);
            }
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            margin: 0 auto 16px;
            border: 4px solid rgba(255, 255, 255, 0.2);
        }

        .profile-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-phone {
            opacity: 0.9;
            font-size: 14px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 480px) {
            .profile-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--gray);
        }

        .profile-menu {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            text-decoration: none;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:active {
            background: var(--light);
        }

        .menu-icon {
            color: var(--primary);
            font-size: 18px;
            margin-right: 12px;
            min-width: 24px;
        }

        .menu-text {
            flex: 1;
            font-size: 15px;
        }

        .menu-value {
            color: var(--gray);
            font-size: 13px;
            margin-left: 10px;
        }

        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            width: 100%;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: auto;
            margin-bottom: auto;
        }

        @media (max-width: 768px) {
            .modal {
                max-height: 90vh;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 14px 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 20px rgba(138, 43, 226, 0.3);
            z-index: 2000;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s ease;
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        @media (min-width: 768px) {
            .notification {
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                width: auto;
            }
            .notification.show {
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Pages */
        .page {
            display: none;
            width: 100%;
            background: white;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            transition: left 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .admin-panel.active {
            left: 0;
        }

        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            display: none;
        }

        .admin-overlay.active {
            display: block;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .admin-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .admin-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .admin-section h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            -webkit-appearance: none;
        }

        .admin-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.2s ease;
        }

        .admin-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .admin-btn.delete {
            background: var(--secondary);
        }

        .admin-btn.success {
            background: var(--success);
        }

        /* Cart Page Styles */
        .cart-item {
            display: flex;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            padding: 12px;
            gap: 12px;
            align-items: center;
            width: 100%;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
            min-width: 0;
        }

        .cart-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
            font-size: 16px;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s ease;
        }

        .quantity-btn:active {
            background: var(--light);
        }

        .cart-item-quantity {
            font-weight: 600;
            min-width: 24px;
            text-align: center;
            font-size: 14px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            font-size: 16px;
        }

        .remove-btn:active {
            background: rgba(255, 107, 107, 0.1);
        }

        .cart-total {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 15px;
        }

        .total-row:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s ease;
        }

        .checkout-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        /* Checkout Form */
        .checkout-form {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-top: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Orders Page */
        .orders-list {
            margin-bottom: 20px;
        }

        .order-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .order-header {
            padding: 15px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-id {
            font-weight: 700;
            color: var(--primary);
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new {
            background: var(--info);
            color: white;
        }

        .status-processing {
            background: var(--warning);
            color: white;
        }

        .status-completed {
            background: var(--success);
            color: white;
        }

        .status-cancelled {
            background: var(--secondary);
            color: white;
        }

        .order-details {
            padding: 15px;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            font-size: 13px;
        }

        .info-label {
            color: var(--gray);
            margin-bottom: 2px;
        }

        .info-value {
            font-weight: 500;
        }

        .order-items {
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .order-item-meta {
            font-size: 12px;
            color: var(--gray);
        }

        .order-item-total {
            font-weight: 700;
            color: var(--primary);
        }

        /* Admin Orders */
        .admin-orders {
            margin-bottom: 20px;
        }

        .admin-order-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .admin-order-header {
            padding: 15px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-order-info {
            flex: 1;
            min-width: 200px;
        }

        .admin-order-customer {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .admin-order-date {
            font-size: 12px;
            color: var(--gray);
        }

        .admin-order-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-btn:active {
            transform: scale(0.95);
        }

        .btn-processing {
            background: var(--warning);
            color: white;
        }

        .btn-completed {
            background: var(--success);
            color: white;
        }

        .btn-cancelled {
            background: var(--secondary);
            color: white;
        }

        /* Favorites Page */
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (min-width: 768px) {
            .favorites-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 992px) {
            .favorites-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Back Button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--dark);
            margin-bottom: 16px;
            transition: background 0.2s ease;
        }

        .back-button:active {
            background: var(--light-gray);
            transform: scale(0.98);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--light-gray);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Category Page Specific */
        .category-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 30px 20px;
            margin: -15px -15px 20px;
            border-radius: 0 0 var(--radius) var(--radius);
            text-align: center;
            width: calc(100% + 30px);
        }

        .category-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .category-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Safe area support for iOS */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(0px, env(safe-area-inset-top, 0px));
                height: calc(60px + max(0px, env(safe-area-inset-top, 0px)));
            }
            
            .header-container {
                margin-top: max(0px, env(safe-area-inset-top, 0px));
            }
            
            .main-nav {
                height: calc(65px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* Fix for iOS input zoom */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 3px;
        }

        /* Promo Code Input */
        .promo-code-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .promo-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .apply-promo-btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .apply-promo-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .promo-success {
            color: var(--success);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .promo-error {
            color: var(--secondary);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Product Page Styles */
        .product-page-header {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .product-image-main {
            width: 100%;
            height: 300px;
            object-fit: contain;
            background: var(--light-gray);
            display: block;
            background-color: #f8f9fa;
        }

        .product-images-thumbnails {
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
        }

        .product-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s ease;
            background-color: #f8f9fa;
        }

        .product-thumbnail.active {
            border-color: var(--primary);
        }

        .product-info {
            padding: 20px;
        }

        .product-title-large {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .product-brand-large {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .product-price-large {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .current-price-large {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .old-price-large {
            font-size: 16px;
            color: var(--gray);
            text-decoration: line-through;
        }

        .discount-large {
            color: var(--secondary);
            font-size: 14px;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .size-selector {
            margin-bottom: 20px;
        }

        .size-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 15px;
        }

        .size-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .size-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .size-btn:hover {
            border-color: var(--primary);
        }

        .size-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .size-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--light-gray);
        }

        .size-chart-link {
            display: block;
            margin-top: 8px;
            color: var(--primary);
            font-size: 13px;
            text-decoration: none;
            cursor: pointer;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .quantity-label {
            font-weight: 600;
            font-size: 15px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn-large {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s ease;
        }

        .quantity-btn-large:active {
            background: var(--light);
        }

        .quantity-value {
            font-weight: 600;
            font-size: 16px;
            min-width: 24px;
            text-align: center;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .buy-now-btn {
            flex: 2;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .buy-now-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .add-to-cart-large {
            flex: 1;
            padding: 15px;
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .add-to-cart-large:active {
            background: var(--light-gray);
            transform: scale(0.98);
        }

        .add-to-cart-large.added {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .product-tabs {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .product-tab-content {
            padding: 20px;
        }

        .product-description {
            font-size: 14px;
            line-height: 1.6;
            color: var(--dark);
            white-space: pre-line;
        }

        .product-specs {
            display: grid;
            gap: 12px;
        }

        .spec-item {
            display: flex;
            justify-content: space-between;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--light-gray);
        }

        .spec-label {
            color: var(--gray);
            font-size: 14px;
        }

        .spec-value {
            font-weight: 500;
            font-size: 14px;
            text-align: right;
        }

        .reviews-section {
            margin-top: 20px;
        }

        .review-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .review-author {
            font-weight: 600;
            font-size: 14px;
        }

        .review-date {
            color: var(--gray);
            font-size: 12px;
        }

        .review-rating {
            color: var(--accent);
            margin-bottom: 8px;
        }

        .review-text {
            font-size: 13px;
            line-height: 1.5;
            color: var(--dark);
        }

        .similar-products {
            margin-top: 30px;
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .add-review-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-review-btn:active {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .delivery-info {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .delivery-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
        }

        .delivery-item:last-child {
            margin-bottom: 0;
        }

        .delivery-icon {
            color: var(--primary);
            font-size: 16px;
            margin-top: 2px;
        }

        .delivery-text {
            font-size: 13px;
            line-height: 1.4;
        }

        .delivery-text strong {
            font-weight: 600;
            color: var(--dark);
        }

        .rating-stars {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rating-stars i {
            color: #FFD700;
        }

        .rating-value {
            margin-left: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .rating-count {
            color: var(--gray);
            font-size: 13px;
            margin-left: 4px;
        }

        /* Characteristic item */
        .characteristic-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-gray);
        }

        .char-name {
            color: var(--gray);
            font-size: 14px;
            flex: 1;
        }

        .char-value {
            font-weight: 500;
            font-size: 14px;
            text-align: right;
            flex: 1;
        }

        /* Stock status */
        .stock-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .in-stock {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .out-of-stock {
            background: rgba(255, 107, 107, 0.1);
            color: var(--secondary);
        }

        /* Фикс для изображений в Telegram Web App */
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }

        .product-image, .product-image-main, .product-thumbnail {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Новые стили для админ-панели */
        .size-management {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .size-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .size-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .size-tag {
            padding: 6px 12px;
            background: var(--light);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .size-tag .remove-size {
            color: var(--secondary);
            cursor: pointer;
            font-size: 12px;
        }

        .characteristic-management {
            margin-bottom: 10px;
        }

        .char-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .char-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .char-list {
            margin-top: 10px;
        }

        .char-tag {
            padding: 8px;
            background: var(--light);
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        /* New styles for sync notification */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--info);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 6px;
        }
        
        .sync-status.show {
            display: flex;
            animation: fadeInDown 0.3s ease;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sync-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Sync Status -->
    <div class="sync-status" id="syncStatus">
        <i class="fas fa-sync"></i>
        <span id="syncText"></span>
    </div>

    <!-- Admin Panel -->
    <div class="admin-overlay" id="adminOverlay"></div>
    
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <div class="admin-title">Админ-панель</div>
            <button class="close-modal" id="closeAdmin">&times;</button>
        </div>
        
        <!-- Секция синхронизации -->
        <div class="admin-section" style="background: #e8f5e9;">
            <h3><i class="fas fa-cloud"></i> Синхронизация с облаком</h3>
            <div style="margin-bottom: 10px; font-size: 13px; color: var(--gray);">
                <p>Товары синхронизируются с облаком для всех пользователей</p>
            </div>
            <button class="admin-btn success" onclick="syncToCloud()" id="syncCloudBtn">
                <i class="fas fa-cloud-upload-alt"></i> Загрузить в облако
            </button>
            <button class="admin-btn" onclick="loadFromCloud()" id="loadCloudBtn">
                <i class="fas fa-cloud-download-alt"></i> Загрузить из облака
            </button>
            <div style="margin-top: 10px; font-size: 12px; color: var(--gray);">
                <div id="cloudStatus">Статус: не синхронизировано</div>
            </div>
        </div>
        
        <!-- Управление отзывами -->
        <div class="admin-section">
            <h3><i class="fas fa-comment"></i> Управление отзывами</h3>
            <select class="admin-input" id="adminReviewProduct">
                <option value="">Выберите товар</option>
            </select>
            <input type="text" class="admin-input" id="reviewAuthor" placeholder="Имя автора">
            <input type="number" class="admin-input" id="reviewRating" placeholder="Рейтинг (1-5)" min="1" max="5">
            <textarea class="admin-input" id="reviewText" placeholder="Текст отзыва" rows="3"></textarea>
            <button class="admin-btn success" id="addReviewBtn">Добавить отзыв</button>
            <button class="admin-btn" onclick="viewProductReviews()">Просмотреть отзывы</button>
        </div>
        
        <!-- Добавление товаров пакетами -->
        <div class="admin-section">
            <h3><i class="fas fa-boxes"></i> Добавить товары пакетами</h3>
            <select class="admin-input" id="adminBulkCategory">
                <option value="">Выберите категорию</option>
            </select>
            <textarea class="bulk-textarea" id="bulkProducts" placeholder="Введите товары в формате JSON:
[
  {
    'name': 'Название товара',
    'brand': 'Бренд',
    'price': 1000,
    'oldPrice': 1200,
    'image': 'URL картинки',
    'description': 'Описание товара'
  }
]"></textarea>
            <button class="admin-btn success" id="addBulkProducts">Добавить товары пакетом</button>
        </div>
        
        <!-- Управление размерами -->
        <div class="admin-section">
            <h3><i class="fas fa-ruler"></i> Управление размерами товара</h3>
            <select class="admin-input" id="adminProductManage">
                <option value="">Выберите товар</option>
            </select>
            
            <div id="sizeManagementSection" style="display: none;">
                <div class="size-management">
                    <input type="text" class="size-input" id="newSize" placeholder="Новый размер (например, M)">
                    <button class="admin-btn" onclick="addProductSize()">Добавить</button>
                </div>
                <div id="availableSizesList"></div>
                
                <div class="size-management" style="margin-top: 15px;">
                    <input type="text" class="size-input" id="removeSize" placeholder="Размер для удаления">
                    <button class="admin-btn delete" onclick="removeProductSize()">Удалить</button>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px;">
                    <input type="checkbox" id="hideSizesForAccessories">
                    Скрыть размеры для аксессуаров
                </label>
                <button class="admin-btn" onclick="applySizeRules()">Применить правило</button>
            </div>
        </div>
        
        <!-- Управление характеристиками -->
        <div class="admin-section">
            <h3><i class="fas fa-list-alt"></i> Управление характеристиками</h3>
            <select class="admin-input" id="adminCharProduct">
                <option value="">Выберите товар</option>
            </select>
            
            <div id="characteristicManagement" style="display: none;">
                <div class="characteristic-management">
                    <div class="char-row">
                        <input type="text" class="char-input" id="charName" placeholder="Название характеристики">
                        <input type="text" class="char-input" id="charValue" placeholder="Значение">
                        <button class="admin-btn" onclick="addCharacteristic()">Добавить</button>
                    </div>
                    <div id="characteristicsList"></div>
                    
                    <div class="char-row" style="margin-top: 15px;">
                        <input type="text" class="char-input" id="removeCharName" placeholder="Название для удаления">
                        <button class="admin-btn delete" onclick="removeCharacteristic()">Удалить</button>
                    </div>
                </div>
                
                <button class="admin-btn success" onclick="saveCharacteristics()">Сохранить характеристики</button>
            </div>
        </div>
        
        <!-- Существующие разделы админки -->
        <div class="admin-section">
            <h3><i class="fas fa-image"></i> Заменить картинку категории</h3>
            <select class="admin-input" id="adminCategorySelect">
                <option value="">Выберите категорию</option>
            </select>
            <input type="text" class="admin-input" id="adminCategoryImage" placeholder="Новый URL картинки">
            <button class="admin-btn" id="adminUpdateCategoryImage">Обновить картинку</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-tags"></i> Добавить категорию</h3>
            <input type="text" class="admin-input" id="adminNewCategoryName" placeholder="Название категории">
            <input type="text" class="admin-input" id="adminNewCategoryImage" placeholder="URL картинки">
            <button class="admin-btn" id="adminAddCategory">Добавить категорию</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-box"></i> Добавить товар</h3>
            <input type="text" class="admin-input" id="adminProductName" placeholder="Название товара">
            <input type="number" class="admin-input" id="adminProductPrice" placeholder="Цена">
            <select class="admin-input" id="adminProductCategory">
                <option value="">Категория товара</option>
            </select>
            <input type="text" class="admin-input" id="adminProductImage" placeholder="URL картинки">
            <textarea class="admin-input" id="adminProductDescription" placeholder="Описание товара" rows="3"></textarea>
            <button class="admin-btn" id="adminAddProduct">Добавить товар</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-trash"></i> Удалить товар</h3>
            <select class="admin-input" id="adminDeleteProduct">
                <option value="">Выберите товар</option>
            </select>
            <button class="admin-btn delete" id="adminDeleteProductBtn">Удалить товар</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-ticket-alt"></i> Управление промокодами</h3>
            <input type="text" class="admin-input" id="promoCode" placeholder="Код промокода">
            <input type="number" class="admin-input" id="promoDiscount" placeholder="Скидка в %">
            <input type="number" class="admin-input" id="promoMaxUses" placeholder="Максимум использований">
            <input type="datetime-local" class="admin-input" id="promoExpiry" placeholder="Дата истечения">
            <button class="admin-btn success" id="createPromoBtn">Создать промокод</button>
            <button class="admin-btn" onclick="viewPromoCodes()">Просмотреть промокоды</button>
            <button class="admin-btn delete" onclick="clearExpiredPromos()">Очистить истекшие</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-shopping-cart"></i> Управление заказами</h3>
            <button class="admin-btn" onclick="switchPage('admin-orders')">Просмотреть заказы</button>
            <button class="admin-btn success" onclick="updateAllOrders()">Обновить статусы</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-database"></i> Данные</h3>
            <button class="admin-btn" onclick="exportData()">Экспортировать всё</button>
            <button class="admin-btn" onclick="importData()">Импортировать данные</button>
            <button class="admin-btn delete" onclick="resetData()">Сбросить все данные</button>
        </div>
        
        <div class="admin-section">
            <h3><i class="fas fa-users"></i> Пользователи</h3>
            <button class="admin-btn" onclick="viewAllUsers()">Просмотреть всех пользователей</button>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal-overlay" id="promoCodesModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Промокоды</div>
                <button class="close-modal" onclick="closePromoCodesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="promoCodesList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="usersModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Все пользователи</div>
                <button class="close-modal" onclick="closeUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Отзывы товара</div>
                <button class="close-modal" onclick="closeReviewsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reviewsList"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="#" class="logo" onclick="switchPage('home'); return false;">
                <span class="logo-icon">🦄</span>
                <span class="logo-text">UNICORN</span>
            </a>
            
            <div class="header-actions">
                <button class="action-btn" id="favoritesBtn" onclick="switchPage('favorites')">
                    <i class="far fa-heart"></i>
                    <span class="badge" id="favoritesBadge" style="display: none;">0</span>
                </button>
                <button class="action-btn" id="cartBtn" onclick="switchPage('cart')">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="badge" id="cartBadge">0</span>
                </button>
                <div class="user-menu" id="profileBtn" onclick="switchPage('profile')">
                    <div class="user-avatar" id="userAvatar">?</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <a href="#" class="nav-item active" onclick="switchPage('home'); return false;">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="#" class="nav-item" onclick="switchPage('categories'); return false;">
                <i class="fas fa-th-large"></i>
                <span>Категории</span>
            </a>
            <a href="#" class="nav-item" onclick="switchPage('favorites'); return false;">
                <i class="far fa-heart"></i>
                <span>Избранное</span>
            </a>
            <a href="#" class="nav-item" onclick="switchPage('profile'); return false;">
                <i class="far fa-user"></i>
                <span>Профиль</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="container">
                <div class="banner">
                    <div class="banner-content">
                        <div class="banner-badge">🔥 Горячая распродажа</div>
                        <h2 class="banner-title">Скидка 50% на всё!</h2>
                        <p class="banner-subtitle">Только до конца недели. Успей купить!</p>
                        <button class="add-to-cart" onclick="switchPage('categories')">
                            <i class="fas fa-bolt"></i>
                            Смотреть товары
                        </button>
                    </div>
                    <div class="banner-unicorn">🦄</div>
                </div>

                <div class="section-header">
                    <h2 class="section-title">Категории</h2>
                </div>

                <div class="categories-grid" id="mainCategories">
                    <!-- Categories will be loaded here -->
                </div>

                <div class="section-header">
                    <h2 class="section-title">Популярные товары</h2>
                </div>

                <div class="products-grid" id="popularProducts">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Product Page -->
        <div id="product-page" class="page">
            <div class="container">
                <button class="back-button" onclick="goBackFromProduct()">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
                
                <div id="productPageContent">
                    <!-- Product page content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Category Page -->
        <div id="category-page" class="page">
            <div class="container">
                <button class="back-button" onclick="switchPage('categories')">
                    <i class="fas fa-arrow-left"></i>
                    Назад к категориям
                </button>
                
                <div id="categoryHeader">
                    <!-- Category header will be loaded here -->
                </div>
                
                <div class="products-grid" id="categoryProducts">
                    <!-- Category products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Categories Page -->
        <div id="categories" class="page">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Категории</h2>
                </div>

                <div class="categories-grid" id="categoriesGrid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Favorites Page -->
        <div id="favorites" class="page">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Избранное</h2>
                </div>
                
                <div id="favoritesContent">
                    <!-- Favorites will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Cart Page -->
        <div id="cart" class="page">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Корзина</h2>
                </div>
                
                <div id="cartContent">
                    <!-- Cart will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Checkout Page -->
        <div id="checkout" class="page">
            <div class="container">
                <button class="back-button" onclick="switchPage('cart')">
                    <i class="fas fa-arrow-left"></i>
                    Назад в корзину
                </button>
                
                <div class="section-header">
                    <h2 class="section-title">Оформление заказа</h2>
                </div>
                
                <div id="checkoutContent">
                    <!-- Checkout form will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile" class="page">
            <div class="container">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">?</div>
                    <h2 class="profile-name" id="profileName">Гость</h2>
                    <p class="profile-phone" id="profilePhone">Не авторизован</p>
                </div>

                <div class="tabs" id="profileTabs">
                    <button class="tab active" onclick="switchProfileTab('stats')">Статистика</button>
                    <button class="tab" onclick="switchProfileTab('orders')">Мои заказы</button>
                    <button class="tab" onclick="switchProfileTab('settings')">Настройки</button>
                </div>

                <!-- Stats Tab -->
                <div id="statsTab" class="tab-content active">
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="statOrders">0</div>
                            <div class="stat-label">Заказы</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statReviews">0</div>
                            <div class="stat-label">Отзывы</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statFavorites">0</div>
                            <div class="stat-label">Избранное</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statViewed">0</div>
                            <div class="stat-label">Просмотренные</div>
                        </div>
                    </div>

                    <div class="profile-menu">
                        <a href="#" class="menu-item" onclick="openPhoneModal()">
                            <i class="fas fa-phone menu-icon"></i>
                            <span class="menu-text">Добавить номер телефона</span>
                        </a>
                        <a href="#" class="menu-item" onclick="openAddressModal()">
                            <i class="fas fa-shipping-fast menu-icon"></i>
                            <span class="menu-text">Данные доставки</span>
                        </a>
                        <a href="#" class="menu-item" onclick="openCustomsModal()">
                            <i class="fas fa-passport menu-icon"></i>
                            <span class="menu-text">Данные для таможни</span>
                        </a>
                        <a href="#" class="menu-item" onclick="openInviteModal()">
                            <i class="fas fa-user-friends menu-icon"></i>
                            <span class="menu-text">Пригласить друга</span>
                            <span class="menu-value">+500 ₽</span>
                        </a>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="ordersTab" class="tab-content">
                    <div id="userOrdersContent">
                        <!-- User orders will be loaded here -->
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div class="profile-menu">
                        <a href="#" class="menu-item" onclick="exportUserData()">
                            <i class="fas fa-download menu-icon"></i>
                            <span class="menu-text">Экспорт моих данных</span>
                        </a>
                        <a href="#" class="menu-item" onclick="clearUserData()">
                            <i class="fas fa-trash menu-icon"></i>
                            <span class="menu-text">Очистить мои данные</span>
                        </a>
                        <a href="#" class="menu-item" onclick="changeUserName()">
                            <i class="fas fa-user-edit menu-icon"></i>
                            <span class="menu-text">Изменить имя</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Orders Page -->
        <div id="admin-orders" class="page">
            <div class="container">
                <button class="back-button" onclick="switchPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    На главную
                </button>
                
                <div class="section-header">
                    <h2 class="section-title">Управление заказами</h2>
                </div>
                
                <div id="adminOrdersContent">
                    <!-- Admin orders will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px;">
        <div class="loading" style="width: 40px; height: 40px;"></div>
        <div style="font-size: 14px; color: var(--gray);">Загрузка...</div>
    </div>

    <script>
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '8297619186:AAFALMlS8mt2FpUwNzorLQalkOshPpULb2Y';
        const TELEGRAM_CHAT_ID = '6644058285';
        const ADMIN_USER_ID = '6644058285';

        // GitHub Gist Configuration for Cloud Storage
        const GITHUB_GIST_ID = ''; // Оставьте пустым - будет создан автоматически
        const GITHUB_TOKEN = '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'; // Замените на свой GitHub token
        // Как получить GitHub token: 
        // 1. Зайдите на https://github.com/settings/tokens
        // 2. Нажмите "Generate new token" (классический)
        // 3. Выберите "gist" в правах
        // 4. Скопируйте токен и вставьте выше

        const CLOUD_STORAGE_KEY = 'unicorn_cloud_data';

        // Улучшенные данные
        const defaultCategories = {
            "men": {
                id: "men",
                name: "Мужская одежда",
                image: "https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                description: "Стильная мужская одежда"
            },
            "women": {
                id: "women",
                name: "Женская одежда",
                image: "https://images.unsplash.com/photo-1490481651871-ab68de25d43d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                description: "Модная женская одежда"
            },
            "shoes": {
                id: "shoes",
                name: "Обувь",
                image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                description: "Обувь для каждого сезона"
            },
            "accessories": {
                id: "accessories",
                name: "Аксессуары",
                image: "https://images.unsplash.com/photo-1583394838336-acd977736f90?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                description: "Аксессуары и украшения"
            }
        };

        const defaultProducts = [
            {
                id: 1,
                name: "Кроссовки Nike Air Force 1 '07",
                brand: "Nike",
                price: 12990,
                oldPrice: 15990,
                discount: 19,
                category: "shoes",
                image: "https://images.unsplash.com/photo-1600269452121-4f2416e55c28?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                images: [
                    "https://images.unsplash.com/photo-1600269452121-4f2416e55c28?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                    "https://images.unsplash.com/photo-1600185365926-3a2ce3cdb9eb?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                    "https://images.unsplash.com/photo-1600185365483-8c21ba5c6bcf?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
                ],
                description: "Кроссовки Nike Air Force 1 '07 — это обновленная версия культовой баскетбольной обуви 1982 года. Эта модель сохранила все классические детали, включая прочный кожаный верх, перфорированные отверстия на мыске и фирменную подошву с технологией Nike Air.\n\nИдеально подходят для повседневной носки, сочетают в себе комфорт и стиль. Универсальный белый цвет делает их подходящими для любого образа.",
                characteristics: {
                    "Материал верха": "Натуральная кожа",
                    "Материал подкладки": "Текстиль",
                    "Материал подошвы": "Резина",
                    "Технология": "Nike Air",
                    "Вес": "450 г (пара)",
                    "Производство": "Вьетнам",
                    "Сезон": "Круглый год",
                    "Пол": "Унисекс"
                },
                sizes: ["36", "37", "38", "39", "40", "41", "42", "43", "44", "45"],
                availableSizes: ["36", "37", "38", "39", "40", "41", "42", "43"],
                materials: "Натуральная кожа, текстиль, резина",
                colors: ["Белый", "Черный"],
                rating: 4.7,
                reviewsCount: 128,
                inStock: true,
                deliveryTime: "1-3 дня",
                warranty: "30 дней",
                reviews: [
                    {
                        id: 1,
                        author: "Анна Смирнова",
                        rating: 5,
                        date: "2024-01-15",
                        text: "Отличные кроссовки! Очень удобные и стильные. Качество на высоте."
                    },
                    {
                        id: 2,
                        author: "Иван Петров",
                        rating: 4,
                        date: "2024-01-10",
                        text: "Хорошие кроссовки, но немного жесткие в первые дни носки."
                    }
                ]
            },
            {
                id: 2,
                name: "Джинсы Levi's 501 Original Fit",
                brand: "Levi's",
                price: 7990,
                oldPrice: 9990,
                discount: 20,
                category: "men",
                image: "https://images.unsplash.com/photo-1542272604-787c3835535d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                images: [
                    "https://images.unsplash.com/photo-1542272604-787c3835535d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
                    "https://images.unsplash.com/photo-1541099649105-f69ad21a3246?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
                ],
                description: "Джинсы Levi's 501 Original Fit — это классика, которая никогда не выходит из моды. Впервые представленные в 1873 году, эти джинсы стали символом американского стиля.\n\nОсобенности модели:\n• Прямой крой от бедра до щиколотки\n• Классическая посадка на талии\n• Застежка на молнию и пуговицу\n• 5 карманов (2 спереди, 2 сзади, 1 маленький для часов)\n• Фирменная заклепка Levi's\n• 100% хлопковый деним\n\nИдеально подходят для создания как повседневных, так и более формальных образов.",
                characteristics: {
                    "Материал": "100% хлопок (деним)",
                    "Плотность": "14 унций",
                    "Крой": "Прямой (Original Fit)",
                    "Посадка": "На талии",
                    "Застежка": "Молния и пуговица",
                    "Карманы": "5",
                    "Стирка": "Рекомендуется ручная стирка",
                    "Производство": "США"
                },
                sizes: ["28", "30", "32", "34", "36", "38", "40"],
                availableSizes: ["30", "32", "34", "36"],
                materials: "100% хлопок (деним)",
                colors: ["Синий деним", "Черный", "Светло-синий"],
                rating: 4.5,
                reviewsCount: 89,
                inStock: true,
                deliveryTime: "2-4 дня",
                warranty: "6 месяцев",
                reviews: [
                    {
                        id: 1,
                        author: "Мария Иванова",
                        rating: 5,
                        date: "2024-01-12",
                        text: "Лучшие джинсы! Классика на все времена."
                    }
                ]
            }
        ];

        // Application state
        let categories = {};
        let products = [];
        let currentUserId = null;
        let userData = null;
        let currentCategory = '';
        let isAdmin = false;
        let isInitialized = false;
        let telegramUsername = '';
        let telegramFirstName = '';
        let telegramLastName = '';
        let telegramUserId = '';
        let activePromoCode = null;
        let promoDiscount = 0;
        let currentProductId = null;
        let selectedSize = null;
        let selectedQuantity = 1;
        let lastPage = 'home';
        
        // Cloud sync variables
        let cloudGistId = localStorage.getItem('unicorn_cloud_gist_id') || GITHUB_GIST_ID;
        let lastCloudSync = localStorage.getItem('unicorn_last_cloud_sync') || null;
        let cloudSynced = false;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            await initApp();
        });

        // ==============================================
        // ОСНОВНЫЕ ФУНКЦИИ СИНХРОНИЗАЦИИ С ОБЛАКОМ
        // ==============================================

        // Функция синхронизации с облаком (GitHub Gist)
        async function syncToCloud() {
            try {
                if (!GITHUB_TOKEN || GITHUB_TOKEN === 'ghp_111111111111111111111111111111111111') {
                    showNotification('GitHub token не настроен. Пожалуйста, настройте токен в коде.');
                    return;
                }
                
                showSyncStatus('Синхронизация с облаком...', 'info');
                
                const dataToSync = {
                    categories: categories,
                    products: products,
                    promoCodes: JSON.parse(localStorage.getItem('unicorn_promocodes')) || [],
                    allOrders: JSON.parse(localStorage.getItem('unicorn_all_orders')) || [],
                    timestamp: new Date().toISOString(),
                    syncedBy: currentUserId,
                    version: '1.0'
                };
                
                let gistId = cloudGistId;
                
                if (!gistId) {
                    // Создаем новый Gist
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: 'UNICORN Shop Cloud Data',
                            public: false,
                            files: {
                                'unicorn_data.json': {
                                    content: JSON.stringify(dataToSync, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Ошибка создания Gist');
                    }
                    
                    const result = await response.json();
                    gistId = result.id;
                    cloudGistId = gistId;
                    localStorage.setItem('unicorn_cloud_gist_id', gistId);
                    
                    showSyncStatus('Облако создано и синхронизировано!', 'success');
                    
                } else {
                    // Обновляем существующий Gist
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: 'UNICORN Shop Cloud Data - Updated',
                            files: {
                                'unicorn_data.json': {
                                    content: JSON.stringify(dataToSync, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            // Gist не найден, создаем новый
                            cloudGistId = '';
                            localStorage.removeItem('unicorn_cloud_gist_id');
                            await syncToCloud();
                            return;
                        }
                        throw new Error('Ошибка обновления Gist');
                    }
                    
                    showSyncStatus('Данные синхронизированы с облаком!', 'success');
                }
                
                lastCloudSync = new Date().toISOString();
                localStorage.setItem('unicorn_last_cloud_sync', lastCloudSync);
                cloudSynced = true;
                
                updateCloudStatus();
                
                // Сохраняем в localStorage как резервную копию
                localStorage.setItem('unicorn_cloud_backup', JSON.stringify(dataToSync));
                
            } catch (error) {
                console.error('Ошибка синхронизации с облаком:', error);
                showSyncStatus('Ошибка синхронизации', 'error');
                
                // Пробуем сохранить в localStorage как запасной вариант
                try {
                    const dataToSync = {
                        categories: categories,
                        products: products,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem(CLOUD_STORAGE_KEY, JSON.stringify(dataToSync));
                    showNotification('Данные сохранены локально (облако недоступно)');
                } catch (e) {
                    console.error('Ошибка локального сохранения:', e);
                }
            }
        }

        // Функция загрузки данных из облака
        async function loadFromCloud() {
            try {
                showSyncStatus('Загрузка данных из облака...', 'info');
                
                if (!cloudGistId) {
                    showSyncStatus('Облако не настроено', 'error');
                    return;
                }
                
                const response = await fetch(`https://api.github.com/gists/${cloudGistId}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showSyncStatus('Облако не найдено', 'error');
                        cloudGistId = '';
                        localStorage.removeItem('unicorn_cloud_gist_id');
                        return;
                    }
                    throw new Error('Ошибка загрузки Gist');
                }
                
                const gist = await response.json();
                const content = gist.files['unicorn_data.json'].content;
                const cloudData = JSON.parse(content);
                
                // Проверяем версию данных
                if (!cloudData.products || !cloudData.categories) {
                    throw new Error('Неверный формат данных в облаке');
                }
                
                // Обновляем локальные данные
                categories = cloudData.categories;
                products = cloudData.products;
                
                // Обновляем дополнительные данные если они есть
                if (cloudData.promoCodes) {
                    localStorage.setItem('unicorn_promocodes', JSON.stringify(cloudData.promoCodes));
                }
                
                if (cloudData.allOrders) {
                    localStorage.setItem('unicorn_all_orders', JSON.stringify(cloudData.allOrders));
                }
                
                // Сохраняем локально
                saveCategories();
                saveProducts();
                
                lastCloudSync = cloudData.timestamp;
                localStorage.setItem('unicorn_last_cloud_sync', lastCloudSync);
                cloudSynced = true;
                
                showSyncStatus('Данные загружены из облака!', 'success');
                updateCloudStatus();
                
                // Обновляем UI
                if (isInitialized) {
                    loadMainCategories();
                    loadPopularProducts();
                    loadAdminData();
                    
                    const activePage = document.querySelector('.page.active').id;
                    if (activePage === 'home') {
                        loadMainCategories();
                        loadPopularProducts();
                    } else if (activePage === 'categories') {
                        loadCategoriesPage();
                    } else if (activePage === 'category-page') {
                        loadCategoryPage(currentCategory);
                    } else if (activePage === 'favorites') {
                        loadFavoritesPage();
                    }
                }
                
            } catch (error) {
                console.error('Ошибка загрузки из облака:', error);
                showSyncStatus('Ошибка загрузки из облака', 'error');
                
                // Пробуем загрузить из localStorage как запасной вариант
                try {
                    const localCloudData = localStorage.getItem(CLOUD_STORAGE_KEY);
                    if (localCloudData) {
                        const data = JSON.parse(localCloudData);
                        if (data.categories && data.products) {
                            categories = data.categories;
                            products = data.products;
                            saveCategories();
                            saveProducts();
                            
                            showNotification('Данные загружены из локального кэша');
                            
                            if (isInitialized) {
                                loadMainCategories();
                                loadPopularProducts();
                                loadAdminData();
                            }
                        }
                    }
                } catch (e) {
                    console.error('Ошибка загрузки локального кэша:', e);
                }
            }
        }

        // Функция автоматической проверки синхронизации при запуске
        async function checkCloudSync() {
            try {
                if (!cloudGistId) return;
                
                // Проверяем когда была последняя синхронизация
                const lastSync = localStorage.getItem('unicorn_last_cloud_sync');
                const now = new Date();
                
                if (lastSync) {
                    const lastSyncDate = new Date(lastSync);
                    const hoursDiff = (now - lastSyncDate) / (1000 * 60 * 60);
                    
                    // Если прошло больше 1 часа, проверяем обновления
                    if (hoursDiff > 1) {
                        await loadFromCloud();
                    } else {
                        cloudSynced = true;
                        updateCloudStatus();
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки синхронизации:', error);
            }
        }

        // Функция обновления статуса облака в UI
        function updateCloudStatus() {
            const cloudStatusElement = document.getElementById('cloudStatus');
            if (!cloudStatusElement) return;
            
            if (cloudSynced && lastCloudSync) {
                const syncDate = new Date(lastCloudSync);
                cloudStatusElement.innerHTML = `
                    Статус: <span style="color: var(--success);">Синхронизировано</span><br>
                    Последняя синхронизация: ${syncDate.toLocaleDateString('ru-RU')} ${syncDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}
                `;
            } else if (cloudGistId) {
                cloudStatusElement.innerHTML = 'Статус: <span style="color: var(--warning);">Требуется синхронизация</span>';
            } else {
                cloudStatusElement.innerHTML = 'Статус: <span style="color: var(--gray);">Облако не настроено</span>';
            }
        }

        // Функция показа статуса синхронизации
        function showSyncStatus(message, type = 'info') {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            if (!syncStatus || !syncText) return;
            
            // Устанавливаем цвет в зависимости от типа
            const colors = {
                'info': 'var(--info)',
                'success': 'var(--success)',
                'error': 'var(--secondary)',
                'warning': 'var(--warning)'
            };
            
            syncStatus.style.background = colors[type] || colors.info;
            syncText.textContent = message;
            syncStatus.classList.add('show');
            
            // Скрываем через 3 секунды
            setTimeout(() => {
                syncStatus.classList.remove('show');
            }, 3000);
        }

        // ==============================================
        // ОСНОВНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ
        // ==============================================

        async function initApp() {
            try {
                showLoading(true);
                
                // Проверяем и загружаем настройки облака
                cloudGistId = localStorage.getItem('unicorn_cloud_gist_id') || GITHUB_GIST_ID;
                lastCloudSync = localStorage.getItem('unicorn_last_cloud_sync') || null;
                
                // Восстанавливаем сессию ДО загрузки данных
                const sessionData = restoreUserSession();
                
                // Загружаем данные
                await loadAllData();
                
                // Определяем ID пользователя
                let userIdFromHash = null;
                const hash = window.location.hash;
                
                if (hash.includes('profile-')) {
                    userIdFromHash = hash.split('profile-')[1];
                }
                
                // Приоритет: Telegram ID > ID из хэша > сохраненный ID
                if (telegramUserId) {
                    currentUserId = telegramUserId;
                    console.log('Используем Telegram ID:', currentUserId);
                } else if (userIdFromHash) {
                    currentUserId = decodeURIComponent(userIdFromHash);
                    console.log('Используем ID из хэша:', currentUserId);
                } else if (sessionData && sessionData.userId) {
                    currentUserId = sessionData.userId;
                    console.log('Используем ID из сессии:', currentUserId);
                } else {
                    const randomNum = Math.floor(1000 + Math.random() * 9000);
                    currentUserId = `user_${Date.now()}_${randomNum}`;
                    console.log('Создан новый ID:', currentUserId);
                }
                
                // Обновляем хэш в URL
                window.location.hash = `profile-${encodeURIComponent(currentUserId)}`;
                localStorage.setItem('unicorn_userId', currentUserId);
                
                // Загружаем данные пользователя
                userData = getUserData(currentUserId);
                
                // ВОССТАНАВЛИВАЕМ данные из сессии если они есть
                if (sessionData) {
                    if (sessionData.cart && sessionData.cart.length > 0) {
                        sessionData.cart.forEach(sessionItem => {
                            const existingItem = userData.cart.find(item => item.id === sessionItem.id);
                            if (!existingItem) {
                                userData.cart.push(sessionItem);
                            }
                        });
                        console.log('Восстановлена корзина из сессии:', sessionData.cart.length, 'товаров');
                    }
                    
                    if (sessionData.favorites && sessionData.favorites.length > 0) {
                        sessionData.favorites.forEach(favId => {
                            if (!userData.favorites.includes(favId)) {
                                userData.favorites.push(favId);
                            }
                        });
                        console.log('Восстановлено избранное из сессии:', sessionData.favorites.length, 'товаров');
                    }
                    
                    saveUserData();
                }
                
                // Проверяем админские права
                isAdmin = checkAdminRights();
                
                // Инициализируем UI
                await initializeUI();
                
                // Проверяем синхронизацию с облаком
                await checkCloudSync();
                
                // Показываем кнопку админки для администратора
                if (isAdmin) {
                    createAdminToggle();
                    loadAdminData();
                    updateCloudStatus();
                }
                
                isInitialized = true;
                
                // Сохраняем сессию
                saveUserSession();
                
                // Загружаем активную страницу
                const activePage = document.querySelector('.page.active').id;
                if (activePage === 'cart') await loadCartPage();
                if (activePage === 'favorites') await loadFavoritesPage();
                if (activePage === 'profile') loadUserOrders();
                if (activePage === 'admin-orders') loadAdminOrders();
                if (activePage === 'product-page') loadProductPage();
                
                // Показываем приветствие
                if (userData.name && userData.name !== 'Гость') {
                    showNotification(`Добро пожаловать, ${userData.name}!`);
                }
                
                // Если администратор - показываем статус облака
                if (isAdmin && cloudSynced) {
                    showNotification('✅ Данные синхронизированы с облаком');
                }
                
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showNotification('Ошибка загрузки. Пожалуйста, обновите страницу.');
            } finally {
                showLoading(false);
            }
        }

        function checkAdminRights() {
            console.log('Проверка прав администратора:');
            console.log('- Текущий ID:', currentUserId);
            console.log('- Telegram ID:', telegramUserId);
            console.log('- Telegram username:', telegramUsername);
            
            if (telegramUserId && telegramUserId === ADMIN_USER_ID) {
                console.log('✅ Администратор по Telegram ID');
                return true;
            }
            
            if (currentUserId && currentUserId === ADMIN_USER_ID) {
                console.log('✅ Администратор по текущему ID');
                return true;
            }
            
            if (telegramUsername && (telegramUsername === 'barizhka' || telegramUsername === 'admin')) {
                console.log('✅ Администратор по Telegram username');
                return true;
            }
            
            if (userData && userData.name && userData.name.toLowerCase().includes('админ')) {
                console.log('✅ Администратор по имени');
                return true;
            }
            
            console.log('❌ Не администратор');
            return false;
        }

        async function loadAllData() {
            try {
                // Сначала проверяем локальные данные
                const savedCategories = localStorage.getItem('unicorn_categories');
                const savedProducts = localStorage.getItem('unicorn_products');
                
                if (savedCategories && savedProducts) {
                    categories = JSON.parse(savedCategories);
                    products = JSON.parse(savedProducts);
                    console.log('Данные загружены из localStorage');
                } else {
                    // Если нет локальных данных, используем дефолтные
                    categories = JSON.parse(JSON.stringify(defaultCategories));
                    products = JSON.parse(JSON.stringify(defaultProducts));
                    
                    localStorage.setItem('unicorn_categories', JSON.stringify(categories));
                    localStorage.setItem('unicorn_products', JSON.stringify(products));
                    console.log('Созданы дефолтные данные');
                }
                
            } catch (error) {
                console.warn('Ошибка загрузки данных:', error);
                categories = JSON.parse(JSON.stringify(defaultCategories));
                products = JSON.parse(JSON.stringify(defaultProducts));
            }
        }

        // Функция для сохранения сессии
        function saveUserSession() {
            if (!userData) return;
            
            try {
                // Сохраняем сессию пользователя
                const sessionData = {
                    userId: currentUserId,
                    telegramUsername: telegramUsername,
                    telegramFirstName: telegramFirstName,
                    telegramLastName: telegramLastName,
                    telegramUserId: telegramUserId,
                    lastActive: new Date().toISOString(),
                    cart: userData.cart,
                    favorites: userData.favorites,
                    viewed: userData.viewed
                };
                
                localStorage.setItem('unicorn_session', JSON.stringify(sessionData));
                console.log('Сессия сохранена:', currentUserId);
            } catch (error) {
                console.error('Ошибка сохранения сессии:', error);
            }
        }

        // Функция для восстановления сессии
        function restoreUserSession() {
            try {
                const sessionData = JSON.parse(localStorage.getItem('unicorn_session'));
                if (!sessionData) return null;
                
                console.log('Восстановление сессии:', sessionData.userId);
                
                // Восстанавливаем данные из сессии
                telegramUsername = sessionData.telegramUsername || '';
                telegramFirstName = sessionData.telegramFirstName || '';
                telegramLastName = sessionData.telegramLastName || '';
                telegramUserId = sessionData.telegramUserId || '';
                
                // Возвращаем данные для использования
                return sessionData;
            } catch (error) {
                console.error('Ошибка восстановления сессии:', error);
                return null;
            }
        }

        function getUserData(userId) {
            try {
                const users = JSON.parse(localStorage.getItem('unicorn_users')) || {};
                
                let foundUser = null;
                let foundUserId = null;
                
                if (telegramUserId) {
                    for (const uid in users) {
                        if (users[uid].telegramId === telegramUserId) {
                            foundUser = users[uid];
                            foundUserId = uid;
                            break;
                        }
                    }
                }
                
                if (!foundUser && telegramUsername) {
                    for (const uid in users) {
                        if (users[uid].telegramUsername === telegramUsername) {
                            foundUser = users[uid];
                            foundUserId = uid;
                            break;
                        }
                    }
                }
                
                if (foundUser) {
                    console.log('Найден существующий пользователь:', foundUserId, foundUser.name);
                    
                    foundUser.lastActive = new Date().toISOString();
                    
                    if (telegramUsername) foundUser.telegramUsername = telegramUsername;
                    if (telegramFirstName) foundUser.telegramFirstName = telegramFirstName;
                    if (telegramLastName) foundUser.telegramLastName = telegramLastName;
                    if (telegramUserId) foundUser.telegramId = telegramUserId;
                    
                    currentUserId = foundUserId;
                    localStorage.setItem('unicorn_userId', currentUserId);
                    
                    users[foundUserId] = foundUser;
                    localStorage.setItem('unicorn_users', JSON.stringify(users));
                    
                    return foundUser;
                }
                
                if (!users[userId]) {
                    let displayName = '';
                    if (telegramFirstName) {
                        displayName = telegramFirstName;
                        if (telegramLastName) {
                            displayName += ' ' + telegramLastName;
                        }
                    } else if (telegramUsername) {
                        displayName = '@' + telegramUsername;
                    } else {
                        displayName = `Пользователь ${userId.slice(-4)}`;
                    }
                    
                    users[userId] = {
                        id: userId,
                        name: displayName,
                        phone: null,
                        address: null,
                        favorites: [],
                        cart: [],
                        orders: [],
                        viewed: [],
                        reviews: 0,
                        createdAt: new Date().toISOString(),
                        lastActive: new Date().toISOString(),
                        telegramUsername: telegramUsername || null,
                        telegramFirstName: telegramFirstName || null,
                        telegramLastName: telegramLastName || null,
                        telegramId: telegramUserId || null
                    };
                    
                    localStorage.setItem('unicorn_users', JSON.stringify(users));
                    console.log('Создан новый пользователь:', userId, displayName);
                } else {
                    users[userId].lastActive = new Date().toISOString();
                    
                    if (telegramUsername) users[userId].telegramUsername = telegramUsername;
                    if (telegramFirstName) users[userId].telegramFirstName = telegramFirstName;
                    if (telegramLastName) users[userId].telegramLastName = telegramLastName;
                    if (telegramUserId) users[userId].telegramId = telegramUserId;
                    
                    localStorage.setItem('unicorn_users', JSON.stringify(users));
                }
                
                return users[userId];
            } catch (error) {
                console.error('Ошибка загрузки пользователя:', error);
                return createNewUserData(userId);
            }
        }

        function createNewUserData(userId) {
            let displayName = '';
            if (telegramFirstName) {
                displayName = telegramFirstName;
                if (telegramLastName) {
                    displayName += ' ' + telegramLastName;
                }
            } else if (telegramUsername) {
                displayName = '@' + telegramUsername;
            } else {
                displayName = `Пользователь ${userId.slice(-4)}`;
            }
            
            return {
                id: userId,
                name: displayName,
                phone: null,
                address: null,
                favorites: [],
                cart: [],
                orders: [],
                viewed: [],
                reviews: 0,
                createdAt: new Date().toISOString(),
                lastActive: new Date().toISOString(),
                telegramUsername: telegramUsername || null,
                telegramFirstName: telegramFirstName || null,
                telegramLastName: telegramLastName || null,
                telegramId: telegramUserId || null
            };
        }

        function saveUserData() {
            try {
                const users = JSON.parse(localStorage.getItem('unicorn_users')) || {};
                users[currentUserId] = userData;
                localStorage.setItem('unicorn_users', JSON.stringify(users));
                console.log('Данные пользователя сохранены:', currentUserId);
                
                saveUserSession();
                
            } catch (error) {
                console.error('Ошибка сохранения пользователя:', error);
            }
        }

        function saveCategories() {
            try {
                localStorage.setItem('unicorn_categories', JSON.stringify(categories));
                console.log('Категории сохранены');
                
                // Если администратор и включена синхронизация - синхронизируем с облаком
                if (isAdmin && cloudSynced) {
                    // Автоматическая синхронизация при изменении данных администратором
                    setTimeout(() => {
                        if (isAdmin) syncToCloud();
                    }, 2000);
                }
            } catch (error) {
                console.error('Ошибка сохранения категорий:', error);
            }
        }

        function saveProducts() {
            try {
                localStorage.setItem('unicorn_products', JSON.stringify(products));
                console.log('Товары сохранены');
                
                // Если администратор и включена синхронизация - синхронизируем с облаком
                if (isAdmin && cloudSynced) {
                    // Автоматическая синхронизация при изменении данных администратором
                    setTimeout(() => {
                        if (isAdmin) syncToCloud();
                    }, 2000);
                }
            } catch (error) {
                console.error('Ошибка сохранения товаров:', error);
            }
        }

        async function initializeUI() {
            await loadMainCategories();
            await loadPopularProducts();
            updateProfileUI();
            updateCartBadge();
            updateFavoritesBadge();
            setupAdminPanel();
            
            checkAndShowAdminButton();
            
            window.addEventListener('hashchange', handleHashChange);
        }

        function checkAndShowAdminButton() {
            const adminToggle = document.querySelector('.admin-toggle');
            if (isAdmin) {
                if (!adminToggle) {
                    createAdminToggle();
                } else {
                    adminToggle.style.display = 'flex';
                }
                console.log('Админ-кнопка показана');
            } else if (adminToggle) {
                adminToggle.style.display = 'none';
            }
        }

        function handleHashChange() {
            if (!isInitialized) return;
            
            const hash = window.location.hash;
            if (hash.includes('profile-')) {
                const userId = hash.split('profile-')[1];
                if (userId && userId !== currentUserId) {
                    console.log('Смена пользователя по хэшу:', userId);
                    
                    saveUserSession();
                    
                    currentUserId = decodeURIComponent(userId);
                    localStorage.setItem('unicorn_userId', currentUserId);
                    
                    userData = getUserData(currentUserId);
                    
                    const wasAdmin = isAdmin;
                    isAdmin = checkAdminRights();
                    
                    updateProfileUI();
                    updateCartBadge();
                    updateFavoritesBadge();
                    
                    if (wasAdmin !== isAdmin) {
                        checkAndShowAdminButton();
                    }
                    
                    const activePage = document.querySelector('.page.active').id;
                    switchPage(activePage);
                }
            }
        }

        async function loadMainCategories() {
            const container = document.getElementById('mainCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.values(categories).forEach(category => {
                const card = createCategoryCard(category);
                card.onclick = () => openCategoryPage(category.id);
                container.appendChild(card);
            });
        }

        function loadCategoriesPage() {
            const container = document.getElementById('categoriesGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.values(categories).forEach(category => {
                const card = createCategoryCard(category);
                card.onclick = () => openCategoryPage(category.id);
                container.appendChild(card);
            });
        }

        function createCategoryCard(category) {
            const card = document.createElement('div');
            card.className = 'category-card';
            card.innerHTML = `
                <img src="${category.image}" alt="${category.name}" class="category-image" 
                     loading="lazy"
                     onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 400 400\"><rect width=\"400\" height=\"400\" fill=\"%238A2BE2\"/><text x=\"200\" y=\"200\" font-family=\"Inter\" font-size=\"24\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">${encodeURIComponent(category.name)}</text></svg>'">
                <div class="category-content">
                    <h3 class="category-title">${category.name}</h3>
                    <p class="category-count">${getCategoryProductCount(category.id)} товаров</p>
                </div>
            `;
            return card;
        }

        function getCategoryProductCount(categoryId) {
            return products.filter(p => p.category === categoryId).length;
        }

        function openCategoryPage(categoryId) {
            currentCategory = categoryId;
            switchPage('category-page');
            loadCategoryPage(categoryId);
        }

        function loadCategoryPage(categoryId) {
            const category = categories[categoryId];
            if (!category) return;
            
            const header = document.getElementById('categoryHeader');
            header.innerHTML = `
                <div class="category-header">
                    <h1>${category.name}</h1>
                    <p>${category.description}</p>
                </div>
            `;
            
            const productsGrid = document.getElementById('categoryProducts');
            productsGrid.innerHTML = '';
            
            const categoryProducts = products.filter(p => p.category === categoryId);
            
            if (categoryProducts.length === 0) {
                productsGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 8px;">Товары не найдены</h3>
                        <p>В этой категории пока нет товаров</p>
                    </div>
                `;
                return;
            }
            
            categoryProducts.forEach(product => {
                const productElement = createProductElement(product);
                productsGrid.appendChild(productElement);
            });
        }

        async function loadPopularProducts() {
            const container = document.getElementById('popularProducts');
            if (!container) return;
            
            container.innerHTML = '';
            
            const shuffled = [...products].sort(() => 0.5 - Math.random());
            const popular = shuffled.slice(0, 8);
            
            for (let i = 0; i < popular.length; i++) {
                const productElement = createProductElement(popular[i]);
                container.appendChild(productElement);
                
                if (i % 2 === 0) {
                    await new Promise(resolve => requestAnimationFrame(resolve));
                }
            }
        }

        function createProductElement(product) {
            const div = document.createElement('div');
            div.className = 'product-card';
            
            const isFavorite = userData.favorites.includes(product.id);
            const inCart = userData.cart.find(item => item.id === product.id);
            
            div.innerHTML = `
                <div class="product-image-container">
                    <img src="${product.image}" alt="${product.name}" class="product-image" 
                         loading="lazy"
                         onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 400 300\"><rect width=\"400\" height=\"300\" fill=\"%238A2BE2\"/><text x=\"200\" y=\"150\" font-family=\"Inter\" font-size=\"16\" fill=\"white\" text-anchor=\"middle\" dy=\".3em\">${encodeURIComponent(product.name)}</text></svg>'">
                    <button class="wishlist-btn ${isFavorite ? 'active' : ''}" data-id="${product.id}">
                        <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                </div>
                <div class="product-content">
                    <div class="product-brand">${product.brand}</div>
                    <h3 class="product-title">${product.name}</h3>
                    <div class="product-price">
                        <span class="current-price">${product.price.toLocaleString()} ₽</span>
                        ${product.oldPrice ? `<span class="old-price">${product.oldPrice.toLocaleString()} ₽</span>` : ''}
                        ${product.discount > 0 ? `<span class="discount">-${product.discount}%</span>` : ''}
                    </div>
                    <button class="add-to-cart ${inCart ? 'added' : ''}" data-id="${product.id}">
                        <i class="fas fa-${inCart ? 'check' : 'shopping-cart'}"></i>
                        ${inCart ? 'В корзине' : 'В корзину'}
                    </button>
                </div>
            `;
            
            div.addEventListener('click', function(e) {
                if (!e.target.closest('.wishlist-btn') && !e.target.closest('.add-to-cart')) {
                    openProductPage(product.id);
                }
            });
            
            const wishlistBtn = div.querySelector('.wishlist-btn');
            wishlistBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFavorite(product.id);
                const isNowFavorite = userData.favorites.includes(product.id);
                this.classList.toggle('active', isNowFavorite);
                this.innerHTML = `<i class="${isNowFavorite ? 'fas' : 'far'} fa-heart"></i>`;
                updateFavoritesBadge();
                saveUserSession();
            });
            
            const addToCartBtn = div.querySelector('.add-to-cart');
            addToCartBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                addToCart(product);
                this.classList.add('added');
                this.innerHTML = '<i class="fas fa-check"></i> В корзине';
                saveUserSession();
                
                setTimeout(() => {
                    const inCartNow = userData.cart.find(item => item.id === product.id);
                    this.classList.toggle('added', inCartNow);
                    this.innerHTML = `<i class="fas fa-${inCartNow ? 'check' : 'shopping-cart'}"></i> ${inCartNow ? 'В корзине' : 'В корзину'}`;
                }, 2000);
            });
            
            return div;
        }

        function openProductPage(productId) {
            currentProductId = productId;
            lastPage = document.querySelector('.page.active').id;
            switchPage('product-page');
            loadProductPage(productId);
        }

        function loadProductPage(productId = currentProductId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден');
                goBackFromProduct();
                return;
            }
            
            if (!userData.viewed.includes(productId)) {
                userData.viewed.push(productId);
                saveUserData();
                updateProfileUI();
            }
            
            const container = document.getElementById('productPageContent');
            if (!container) return;
            
            const isFavorite = userData.favorites.includes(product.id);
            const inCart = userData.cart.find(item => item.id === product.id);
            const images = product.images || [product.image];
            const mainImage = images[0];
            
            // Проверяем, нужно ли показывать размеры (не показываем для аксессуаров)
            const showSizes = product.category !== 'accessories' && product.sizes && product.sizes.length > 0;
            
            container.innerHTML = `
                <div class="product-page-header">
                    <div class="product-images">
                        <img src="${mainImage}" alt="${product.name}" class="product-image-main" id="mainProductImage">
                        ${images.length > 1 ? `
                            <div class="product-images-thumbnails">
                                ${images.map((img, index) => `
                                    <img src="${img}" alt="${product.name} - изображение ${index + 1}" 
                                         class="product-thumbnail ${index === 0 ? 'active' : ''}" 
                                         data-image="${img}"
                                         onclick="changeProductImage('${img}', this)">
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="product-info">
                        <div class="product-brand-large">${product.brand}</div>
                        <h1 class="product-title-large">${product.name}</h1>
                        
                        <div class="stock-status ${product.inStock ? 'in-stock' : 'out-of-stock'}">
                            <i class="fas ${product.inStock ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${product.inStock ? 'В наличии' : 'Нет в наличии'}
                        </div>
                        
                        <div class="rating-stars" style="margin-bottom: 10px;">
                            ${getRatingStars(product.rating)}
                            <span class="rating-value">${product.rating}</span>
                            <span class="rating-count">(${product.reviewsCount} отзывов)</span>
                        </div>
                        
                        <div class="product-price-large">
                            <span class="current-price-large">${product.price.toLocaleString()} ₽</span>
                            ${product.oldPrice ? `<span class="old-price-large">${product.oldPrice.toLocaleString()} ₽</span>` : ''}
                            ${product.discount > 0 ? `<span class="discount-large">-${product.discount}%</span>` : ''}
                        </div>
                        
                        ${showSizes ? `
                            <div class="size-selector">
                                <label class="size-label">Размер:</label>
                                <div class="size-grid" id="sizeGrid">
                                    ${product.sizes.map(size => `
                                        <button class="size-btn ${product.availableSizes && !product.availableSizes.includes(size) ? 'disabled' : ''}" 
                                                data-size="${size}"
                                                onclick="${product.availableSizes && product.availableSizes.includes(size) ? `selectSize('${size}')` : ''}">
                                            ${size}
                                        </button>
                                    `).join('')}
                                </div>
                                <a href="#" class="size-chart-link" onclick="showSizeChart()">Таблица размеров</a>
                            </div>
                        ` : ''}
                        
                        <div class="quantity-selector">
                            <span class="quantity-label">Количество:</span>
                            <div class="quantity-controls">
                                <button class="quantity-btn-large" onclick="changeQuantity(-1)">-</button>
                                <span class="quantity-value" id="quantityValue">1</span>
                                <button class="quantity-btn-large" onclick="changeQuantity(1)">+</button>
                            </div>
                        </div>
                        
                        <div class="product-actions">
                            <button class="buy-now-btn" onclick="buyNow(${product.id})" ${!product.inStock ? 'disabled' : ''}>
                                <i class="fas fa-bolt"></i>
                                Купить сейчас
                            </button>
                            <button class="add-to-cart-large ${inCart ? 'added' : ''}" onclick="addToCartFromProductPage(${product.id})" ${!product.inStock ? 'disabled' : ''}>
                                <i class="fas fa-${inCart ? 'check' : 'shopping-cart'}"></i>
                                ${inCart ? 'В корзине' : 'В корзину'}
                            </button>
                        </div>
                        
                        <div class="delivery-info">
                            <div class="delivery-item">
                                <i class="fas fa-shipping-fast delivery-icon"></i>
                                <div class="delivery-text">
                                    <strong>Доставка:</strong> ${product.deliveryTime || '1-3 дня'}
                                </div>
                            </div>
                            <div class="delivery-item">
                                <i class="fas fa-undo delivery-icon"></i>
                                <div class="delivery-text">
                                    <strong>Возврат:</strong> ${product.warranty || '30 дней'} без объяснения причин
                                </div>
                            </div>
                            <div class="delivery-item">
                                <i class="fas fa-shield-alt delivery-icon"></i>
                                <div class="delivery-text">
                                    <strong>Гарантия:</strong> ${product.warranty || '30 дней'} от производителя
                                </div>
                            </div>
                        </div>
                        
                        <button class="wishlist-btn" style="position: static; margin-top: 10px;" onclick="toggleFavoriteFromProductPage(${product.id})">
                            <i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i>
                            ${isFavorite ? 'В избранном' : 'Добавить в избранное'}
                        </button>
                    </div>
                </div>
                
                <div class="product-tabs">
                    <div class="tabs">
                        <button class="tab active" onclick="switchProductTab('description')">Описание</button>
                        <button class="tab" onclick="switchProductTab('specs')">Характеристики</button>
                        <button class="tab" onclick="switchProductTab('reviews')">Отзывы (${product.reviewsCount})</button>
                    </div>
                    
                    <div id="descriptionTab" class="product-tab-content tab-content active">
                        <div class="product-description">
                            ${product.description}
                        </div>
                    </div>
                    
                    <div id="specsTab" class="product-tab-content tab-content">
                        <div class="product-specs">
                            ${product.characteristics ? Object.entries(product.characteristics).map(([key, value]) => `
                                <div class="characteristic-item">
                                    <span class="char-name">${key}:</span>
                                    <span class="char-value">${value}</span>
                                </div>
                            `).join('') : `
                                <div class="characteristic-item">
                                    <span class="char-name">Бренд:</span>
                                    <span class="char-value">${product.brand}</span>
                                </div>
                                ${product.materials ? `
                                <div class="characteristic-item">
                                    <span class="char-name">Материал:</span>
                                    <span class="char-value">${product.materials}</span>
                                </div>
                                ` : ''}
                                ${product.colors ? `
                                <div class="characteristic-item">
                                    <span class="char-name">Цвета:</span>
                                    <span class="char-value">${Array.isArray(product.colors) ? product.colors.join(', ') : product.colors}</span>
                                </div>
                                ` : ''}
                                ${product.sizes ? `
                                <div class="characteristic-item">
                                    <span class="char-name">Размеры:</span>
                                    <span class="char-value">${Array.isArray(product.sizes) ? product.sizes.join(', ') : product.sizes}</span>
                                </div>
                                ` : ''}
                                <div class="characteristic-item">
                                    <span class="char-name">Наличие:</span>
                                    <span class="char-value">${product.inStock ? 'В наличии' : 'Нет в наличии'}</span>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div id="reviewsTab" class="product-tab-content tab-content">
                        <div class="reviews-header">
                            <h3>Отзывы покупателей (${product.reviewsCount})</h3>
                            <button class="add-review-btn" onclick="addReview(${product.id})">
                                <i class="fas fa-plus"></i> Добавить отзыв
                            </button>
                        </div>
                        
                        <div class="reviews-section">
                            ${getProductReviews(product.id)}
                        </div>
                    </div>
                </div>
                
                <div class="similar-products">
                    <div class="section-header">
                        <h2 class="section-title">Похожие товары</h2>
                    </div>
                    <div class="products-grid" id="similarProductsGrid"></div>
                </div>
            `;
            
            selectedSize = null;
            selectedQuantity = 1;
            
            loadSimilarProducts(product);
        }

        function getRatingStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            
            let stars = '';
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            
            if (halfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return stars;
        }

        function getProductReviews(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return '';
            
            const reviews = product.reviews || [];
            
            if (reviews.length === 0) {
                return `
                    <div class="empty-state" style="padding: 20px;">
                        <div class="empty-icon">
                            <i class="far fa-comment"></i>
                        </div>
                        <h3 class="empty-title">Отзывов пока нет</h3>
                        <p class="empty-text">Будьте первым, кто оставит отзыв об этом товаре!</p>
                    </div>
                `;
            }
            
            return reviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <div class="review-author">${review.author}</div>
                        <div class="review-date">${new Date(review.date).toLocaleDateString('ru-RU')}</div>
                    </div>
                    <div class="review-rating">
                        ${getRatingStars(review.rating)}
                    </div>
                    <div class="review-text">${review.text}</div>
                </div>
            `).join('');
        }

        function loadSimilarProducts(product) {
            const container = document.getElementById('similarProductsGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            const similarProducts = products
                .filter(p => p.category === product.category && p.id !== product.id);
            
            const shuffled = [...similarProducts].sort(() => 0.5 - Math.random());
            const randomSimilar = shuffled.slice(0, 4);
            
            if (randomSimilar.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--gray);">
                        <p>Похожих товаров не найдено</p>
                    </div>
                `;
                return;
            }
            
            randomSimilar.forEach(product => {
                const productElement = createProductElement(product);
                container.appendChild(productElement);
            });
        }

        function changeProductImage(imageUrl, element) {
            const mainImage = document.getElementById('mainProductImage');
            if (mainImage) {
                mainImage.src = imageUrl;
            }
            
            document.querySelectorAll('.product-thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            
            if (element) {
                element.classList.add('active');
            }
        }

        function selectSize(size) {
            selectedSize = size;
            
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.size === size) {
                    btn.classList.add('active');
                }
            });
        }

        function changeQuantity(delta) {
            selectedQuantity = Math.max(1, selectedQuantity + delta);
            document.getElementById('quantityValue').textContent = selectedQuantity;
        }

        function showSizeChart() {
            const sizeChart = {
                "shoes": {
                    "36": "22.5 см",
                    "37": "23.5 см",
                    "38": "24.0 см",
                    "39": "24.5 см",
                    "40": "25.0 см",
                    "41": "26.0 см",
                    "42": "26.5 см",
                    "43": "27.0 см",
                    "44": "28.0 см",
                    "45": "29.0 см"
                },
                "clothing": {
                    "XS": "42-44 см",
                    "S": "44-46 см",
                    "M": "46-48 см",
                    "L": "48-50 см",
                    "XL": "50-52 см",
                    "XXL": "52-54 см"
                }
            };
            
            const product = products.find(p => p.id === currentProductId);
            if (!product) return;
            
            let chartText = 'Таблица размеров:\n\n';
            
            if (product.category === 'shoes') {
                chartText += 'Размер | Длина стопы\n';
                chartText += '-------|-------------\n';
                Object.entries(sizeChart.shoes).forEach(([size, length]) => {
                    chartText += `${size} | ${length}\n`;
                });
            } else {
                chartText += 'Размер | Обхват груди\n';
                chartText += '-------|-------------\n';
                Object.entries(sizeChart.clothing).forEach(([size, chest]) => {
                    chartText += `${size} | ${chest}\n`;
                });
            }
            
            chartText += '\nРекомендация: Выберите размер, соответствующий вашим меркам.';
            
            alert(chartText);
        }

        function toggleFavoriteFromProductPage(productId) {
            toggleFavorite(productId);
            
            const product = products.find(p => p.id === productId);
            const isNowFavorite = userData.favorites.includes(productId);
            
            const wishlistBtn = document.querySelector('.wishlist-btn');
            if (wishlistBtn) {
                wishlistBtn.innerHTML = `<i class="${isNowFavorite ? 'fas' : 'far'} fa-heart"></i> ${isNowFavorite ? 'В избранном' : 'Добавить в избранное'}`;
            }
            
            updateFavoritesBadge();
            showNotification(isNowFavorite ? 'Товар добавлен в избранное' : 'Товар удален из избранного');
        }

        function addToCartFromProductPage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Проверяем размер для товаров, где он требуется
            const showSizes = product.category !== 'accessories' && product.sizes && product.sizes.length > 0;
            if (showSizes && !selectedSize) {
                showNotification('Пожалуйста, выберите размер');
                return;
            }
            
            addToCart(product, selectedSize, selectedQuantity);
            
            const addToCartBtn = document.querySelector('.add-to-cart-large');
            if (addToCartBtn) {
                addToCartBtn.classList.add('added');
                addToCartBtn.innerHTML = '<i class="fas fa-check"></i> В корзине';
            }
        }

        function buyNow(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const showSizes = product.category !== 'accessories' && product.sizes && product.sizes.length > 0;
            if (showSizes && !selectedSize) {
                showNotification('Пожалуйста, выберите размер');
                return;
            }
            
            addToCart(product, selectedSize, selectedQuantity);
            
            switchPage('checkout');
            loadCheckoutPage();
        }

        function addToCart(product, size = null, quantity = 1) {
            const existingItem = userData.cart.find(item => 
                item.id === product.id && item.size === size
            );
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                userData.cart.push({
                    id: product.id,
                    name: product.name,
                    brand: product.brand,
                    price: product.price,
                    image: product.image,
                    size: size,
                    quantity: quantity
                });
            }
            
            saveUserData();
            updateCartBadge();
            showNotification(`${product.name} добавлен в корзину`);
            
            const activePage = document.querySelector('.page.active').id;
            if (activePage === 'cart') {
                loadCartPage();
            }
        }

        function switchProductTab(tabId) {
            document.querySelectorAll('.product-tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.product-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const activeTab = Array.from(document.querySelectorAll('.product-tabs .tab')).find(tab => 
                tab.textContent.includes(tabId === 'description' ? 'Описание' : 
                                        tabId === 'specs' ? 'Характеристики' : 'Отзывы')
            );
            
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const targetContent = document.getElementById(tabId + 'Tab');
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        function addReview(productId) {
            const reviewText = prompt('Оставьте свой отзыв о товаре:');
            if (reviewText && reviewText.trim()) {
                showNotification('Спасибо за ваш отзыв! Он будет опубликован после модерации.');
            }
        }

        function goBackFromProduct() {
            switchPage(lastPage);
        }

        function toggleFavorite(productId) {
            const index = userData.favorites.indexOf(productId);
            if (index > -1) {
                userData.favorites.splice(index, 1);
            } else {
                userData.favorites.push(productId);
            }
            saveUserData();
            updateProfileUI();
        }

        function removeFromCart(productId) {
            userData.cart = userData.cart.filter(item => item.id !== productId);
            saveUserData();
            updateCartBadge();
            loadCartPage();
            showNotification('Товар удален из корзины');
        }

        function updateCartItemQuantity(productId, quantity) {
            const item = userData.cart.find(item => item.id === productId);
            if (item) {
                if (quantity < 1) {
                    removeFromCart(productId);
                } else {
                    item.quantity = quantity;
                    saveUserData();
                    updateCartBadge();
                    loadCartPage();
                }
            }
        }

        function updateCartBadge() {
            const totalItems = userData.cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = totalItems;
                badge.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        function updateFavoritesBadge() {
            const totalFavorites = userData.favorites.length;
            const badge = document.getElementById('favoritesBadge');
            if (badge) {
                badge.textContent = totalFavorites;
                badge.style.display = totalFavorites > 0 ? 'flex' : 'none';
            }
        }

        function loadCartPage() {
            const container = document.getElementById('cartContent');
            if (!container) return;
            
            if (userData.cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <h3 class="empty-title">В корзине пока ничего нет</h3>
                        <p class="empty-text">Самое время наполнить её!</p>
                        <button class="add-to-cart" onclick="switchPage('home')">
                            <i class="fas fa-store"></i>
                            Перейти к покупкам
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let subtotal = 0;
            
            userData.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                html += `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-info">
                            <h4 class="cart-item-title">${item.name}</h4>
                            <div class="product-brand">${item.brand}</div>
                            ${item.size ? `<div style="font-size: 12px; color: var(--gray);">Размер: ${item.size}</div>` : ''}
                            <div class="cart-item-price">${item.price.toLocaleString()} ₽</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                            <span class="cart-item-quantity">${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                            <button class="remove-btn" onclick="removeFromCart(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div class="cart-total">
                    <div class="promo-code-container">
                        <input type="text" class="promo-input" id="promoCodeInput" placeholder="Введите промокод">
                        <button class="apply-promo-btn" onclick="applyPromoCode()">Применить</button>
                    </div>
            `;
            
            if (activePromoCode) {
                html += `
                    <div class="promo-success">
                        <i class="fas fa-check-circle"></i>
                        Промокод "${activePromoCode.code}" применен! Скидка: ${activePromoCode.discount}%
                    </div>
                `;
            }
            
            const delivery = subtotal > 5000 ? 0 : 500;
            const discountAmount = activePromoCode ? Math.round(subtotal * (activePromoCode.discount / 100)) : 0;
            const total = subtotal + delivery - discountAmount;
            
            html += `
                    <div class="total-row">
                        <span>Сумма товаров</span>
                        <span>${subtotal.toLocaleString()} ₽</span>
                    </div>
                    ${discountAmount > 0 ? `
                    <div class="total-row">
                        <span>Скидка по промокоду</span>
                        <span>-${discountAmount.toLocaleString()} ₽</span>
                    </div>
                    ` : ''}
                    <div class="total-row">
                        <span>Доставка</span>
                        <span>${delivery === 0 ? 'Бесплатно' : delivery.toLocaleString() + ' ₽'}</span>
                    </div>
                    <div class="total-row">
                        <span>Итого</span>
                        <span>${total.toLocaleString()} ₽</span>
                    </div>
                    <button class="checkout-btn" onclick="startCheckout()">
                        <i class="fas fa-credit-card"></i>
                        Оформить заказ
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function applyPromoCode() {
            const promoCodeInput = document.getElementById('promoCodeInput');
            if (!promoCodeInput) return;
            
            const code = promoCodeInput.value.trim().toUpperCase();
            if (!code) {
                showNotification('Введите промокод');
                return;
            }
            
            const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
            const promo = promoCodes.find(p => p.code === code);
            
            if (!promo) {
                showNotification('Промокод не найден');
                return;
            }
            
            if (promo.expiry && new Date(promo.expiry) < new Date()) {
                showNotification('Промокод истек');
                return;
            }
            
            if (promo.maxUses && promo.used >= promo.maxUses) {
                showNotification('Промокод уже использован максимальное количество раз');
                return;
            }
            
            if (promo.usedBy && promo.usedBy.includes(currentUserId)) {
                showNotification('Вы уже использовали этот промокод');
                return;
            }
            
            activePromoCode = promo;
            showNotification(`Промокод "${code}" применен! Скидка: ${promo.discount}%`);
            loadCartPage();
        }

        function startCheckout() {
            if (userData.cart.length === 0) {
                showNotification('Корзина пуста');
                return;
            }
            
            switchPage('checkout');
            loadCheckoutPage();
        }

        function loadCheckoutPage() {
            const container = document.getElementById('checkoutContent');
            if (!container) return;
            
            const subtotal = userData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const delivery = subtotal > 5000 ? 0 : 500;
            const discountAmount = activePromoCode ? Math.round(subtotal * (activePromoCode.discount / 100)) : 0;
            const total = subtotal + delivery - discountAmount;
            
            container.innerHTML = `
                <div class="checkout-form">
                    <div class="form-group">
                        <label class="form-label">ФИО *</label>
                        <input type="text" class="form-input" id="checkoutName" placeholder="Иванов Иван Иванович" value="${userData.name || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Номер телефона *</label>
                        <input type="tel" class="form-input" id="checkoutPhone" placeholder="+7 (999) 999-99-99" value="${userData.phone || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="checkoutEmail" placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Адрес доставки *</label>
                        <textarea class="form-input" id="checkoutAddress" placeholder="Город, улица, дом, квартира" rows="3">${userData.address || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Комментарий к заказу</label>
                        <textarea class="form-input" id="checkoutComment" placeholder="Дополнительные пожелания" rows="2"></textarea>
                    </div>
                    
                    ${activePromoCode ? `
                        <div class="promo-success">
                            <i class="fas fa-ticket-alt"></i>
                            Применен промокод: <strong>${activePromoCode.code}</strong> (скидка ${activePromoCode.discount}%)
                        </div>
                    ` : ''}
                    
                    <div class="cart-total" style="margin-top: 20px;">
                        <div class="total-row">
                            <span>Сумма товаров</span>
                            <span>${subtotal.toLocaleString()} ₽</span>
                        </div>
                        ${discountAmount > 0 ? `
                        <div class="total-row">
                            <span>Скидка по промокоду</span>
                            <span>-${discountAmount.toLocaleString()} ₽</span>
                        </div>
                        ` : ''}
                        <div class="total-row">
                            <span>Доставка</span>
                            <span>${delivery === 0 ? 'Бесплатно' : delivery.toLocaleString() + ' ₽'}</span>
                        </div>
                        <div class="total-row">
                            <span>Итого к оплате</span>
                            <span>${total.toLocaleString()} ₽</span>
                        </div>
                    </div>
                    
                    <button class="checkout-btn" onclick="submitOrder()" style="margin-top: 20px;">
                        <i class="fas fa-check-circle"></i>
                        Подтвердить заказ
                    </button>
                </div>
            `;
        }

        async function submitOrder() {
            const name = document.getElementById('checkoutName').value.trim();
            const phone = document.getElementById('checkoutPhone').value.trim();
            const email = document.getElementById('checkoutEmail').value.trim();
            const address = document.getElementById('checkoutAddress').value.trim();
            const comment = document.getElementById('checkoutComment').value.trim();
            
            if (!name) {
                showNotification('Введите ФИО');
                return;
            }
            
            if (!phone) {
                showNotification('Введите номер телефона');
                return;
            }
            
            if (!email) {
                showNotification('Введите email');
                return;
            }
            
            if (!address) {
                showNotification('Введите адрес доставки');
                return;
            }
            
            userData.name = name;
            userData.phone = phone;
            userData.address = address;
            
            const orderId = 'ORD-' + Date.now();
            const subtotal = userData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const delivery = subtotal > 5000 ? 0 : 500;
            const discountAmount = activePromoCode ? Math.round(subtotal * (activePromoCode.discount / 100)) : 0;
            const total = subtotal + delivery - discountAmount;
            
            const order = {
                id: orderId,
                userId: currentUserId,
                items: [...userData.cart],
                customer: {
                    name: name,
                    phone: phone,
                    email: email,
                    address: address,
                    telegramUsername: telegramUsername,
                    telegramFirstName: telegramFirstName,
                    telegramLastName: telegramLastName
                },
                total: total,
                subtotal: subtotal,
                delivery: delivery,
                discountAmount: discountAmount,
                promoCode: activePromoCode ? activePromoCode.code : null,
                promoDiscount: activePromoCode ? activePromoCode.discount : null,
                comment: comment,
                date: new Date().toISOString(),
                status: 'new',
                statusHistory: [
                    {
                        status: 'new',
                        date: new Date().toISOString(),
                        comment: 'Заказ создан'
                    }
                ]
            };
            
            if (activePromoCode) {
                updatePromoCodeUsage(activePromoCode.code);
            }
            
            userData.orders.push(order);
            userData.cart = [];
            activePromoCode = null;
            
            saveUserData();
            updateCartBadge();
            
            saveOrderToDatabase(order);
            
            await sendTelegramNotification(order);
            
            switchPage('profile');
            switchProfileTab('orders');
            loadUserOrders();
            
            showNotification(`Заказ #${orderId} успешно оформлен! Сумма: ${total.toLocaleString()} ₽`);
        }

        function updatePromoCodeUsage(promoCode) {
            try {
                const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
                const promoIndex = promoCodes.findIndex(p => p.code === promoCode);
                
                if (promoIndex !== -1) {
                    promoCodes[promoIndex].used = (promoCodes[promoIndex].used || 0) + 1;
                    
                    if (!promoCodes[promoIndex].usedBy) {
                        promoCodes[promoIndex].usedBy = [];
                    }
                    promoCodes[promoIndex].usedBy.push(currentUserId);
                    
                    localStorage.setItem('unicorn_promocodes', JSON.stringify(promoCodes));
                }
            } catch (error) {
                console.error('Ошибка обновления промокода:', error);
            }
        }

        async function sendTelegramNotification(order) {
            try {
                let telegramInfo = '';
                if (order.customer.telegramUsername) {
                    telegramInfo = `👤 *Telegram:* @${order.customer.telegramUsername}\n`;
                } else if (order.customer.telegramFirstName) {
                    telegramInfo = `👤 *Имя из Telegram:* ${order.customer.telegramFirstName}`;
                    if (order.customer.telegramLastName) {
                        telegramInfo += ` ${order.customer.telegramLastName}`;
                    }
                    telegramInfo += '\n';
                }
                
                const message = `🛒 *НОВЫЙ ЗАКАЗ #${order.id}*
                
👤 *Клиент:* ${order.customer.name}
📱 *Телефон:* ${order.customer.phone}
📧 *Email:* ${order.customer.email}
📍 *Адрес:* ${order.customer.address}
${telegramInfo}
${order.promoCode ? `🎫 *Промокод:* ${order.promoCode} (скидка ${order.promoDiscount}%)\n` : ''}
📦 *Состав заказа:*
${order.items.map(item => `  • ${item.name} (${item.brand}) - ${item.quantity} × ${item.price.toLocaleString()} ₽ = ${(item.price * item.quantity).toLocaleString()} ₽`).join('\n')}

💰 *Сумма товаров:* ${order.subtotal.toLocaleString()} ₽
${order.discountAmount > 0 ? `🎫 *Скидка:* -${order.discountAmount.toLocaleString()} ₽\n` : ''}🚚 *Доставка:* ${order.delivery === 0 ? 'Бесплатно' : order.delivery.toLocaleString() + ' ₽'}
💰 *Итого к оплате:* ${order.total.toLocaleString()} ₽
📝 *Комментарий:* ${order.comment || 'Нет комментария'}

🕐 *Дата заказа:* ${new Date(order.date).toLocaleString('ru-RU')}`;

                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (!response.ok) {
                    console.error('Ошибка отправки в Telegram:', await response.text());
                }
            } catch (error) {
                console.error('Ошибка отправки уведомления:', error);
            }
        }

        function saveOrderToDatabase(order) {
            try {
                const allOrders = JSON.parse(localStorage.getItem('unicorn_all_orders')) || [];
                allOrders.push(order);
                localStorage.setItem('unicorn_all_orders', JSON.stringify(allOrders));
            } catch (error) {
                console.error('Ошибка сохранения заказа:', error);
            }
        }

        function loadUserOrders() {
            const container = document.getElementById('userOrdersContent');
            if (!container) return;
            
            if (userData.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <h3 class="empty-title">У вас еще нет заказов</h3>
                        <p class="empty-text">Сделайте свой первый заказ!</p>
                        <button class="add-to-cart" onclick="switchPage('home')">
                            <i class="fas fa-store"></i>
                            Перейти к покупкам
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="orders-list">';
            
            const sortedOrders = [...userData.orders].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedOrders.forEach(order => {
                const date = new Date(order.date);
                const statusClass = `status-${order.status}`;
                const statusText = getStatusText(order.status);
                
                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">Заказ #${order.id}</div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="order-details">
                            <div class="order-info">
                                <div class="info-item">
                                    <div class="info-label">Дата</div>
                                    <div class="info-value">${date.toLocaleDateString('ru-RU')}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Сумма</div>
                                    <div class="info-value">${order.total.toLocaleString()} ₽</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Доставка</div>
                                    <div class="info-value">${order.delivery === 0 ? 'Бесплатно' : order.delivery.toLocaleString() + ' ₽'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Товаров</div>
                                    <div class="info-value">${order.items.length}</div>
                                </div>
                            </div>
                            
                            ${order.promoCode ? `
                                <div style="margin: 10px 0; padding: 10px; background: #e8f5e9; border-radius: 8px;">
                                    <i class="fas fa-ticket-alt"></i>
                                    <strong>Промокод:</strong> ${order.promoCode} (скидка ${order.promoDiscount}%)
                                </div>
                            ` : ''}
                            
                            <div class="order-items">
                                ${order.items.map(item => `
                                    <div class="order-item">
                                        <img src="${item.image}" alt="${item.name}" class="order-item-image">
                                        <div class="order-item-info">
                                            <div class="order-item-name">${item.name}</div>
                                            <div class="order-item-meta">
                                                ${item.brand} • ${item.quantity} × ${item.price.toLocaleString()} ₽
                                                ${item.size ? ` • Размер: ${item.size}` : ''}
                                            </div>
                                        </div>
                                        <div class="order-item-total">${(item.price * item.quantity).toLocaleString()} ₽</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${order.comment ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--light-gray);">
                                    <div style="font-size: 13px; color: var(--gray); margin-bottom: 5px;">Комментарий:</div>
                                    <div style="font-size: 14px;">${order.comment}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'Новый',
                'processing': 'В обработке',
                'completed': 'Завершен',
                'cancelled': 'Отменен'
            };
            return statusMap[status] || status;
        }

        function loadAdminOrders() {
            const container = document.getElementById('adminOrdersContent');
            if (!container) return;
            
            try {
                const allOrders = JSON.parse(localStorage.getItem('unicorn_all_orders')) || [];
                
                if (allOrders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <h3 class="empty-title">Заказов пока нет</h3>
                            <p class="empty-text">Ожидайте новые заказы от пользователей</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="admin-orders">';
                
                const sortedOrders = [...allOrders].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                sortedOrders.forEach(order => {
                    const date = new Date(order.date);
                    const statusClass = `status-${order.status}`;
                    const statusText = getStatusText(order.status);
                    
                    let telegramInfo = '';
                    if (order.customer.telegramUsername) {
                        telegramInfo = `👤 Telegram: @${order.customer.telegramUsername}`;
                    } else if (order.customer.telegramFirstName) {
                        telegramInfo = `👤 Имя из Telegram: ${order.customer.telegramFirstName}`;
                        if (order.customer.telegramLastName) {
                            telegramInfo += ` ${order.customer.telegramLastName}`;
                        }
                    }
                    
                    html += `
                        <div class="admin-order-card">
                            <div class="admin-order-header">
                                <div class="admin-order-info">
                                    <div class="admin-order-customer">${order.customer.name}</div>
                                    <div class="admin-order-date">
                                        Заказ #${order.id} • ${date.toLocaleDateString('ru-RU')} ${date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                                <div class="admin-order-actions">
                                    <button class="status-btn btn-processing" onclick="updateOrderStatus('${order.id}', 'processing')">
                                        В обработку
                                    </button>
                                    <button class="status-btn btn-completed" onclick="updateOrderStatus('${order.id}', 'completed')">
                                        Завершить
                                    </button>
                                    <button class="status-btn btn-cancelled" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                                        Отменить
                                    </button>
                                </div>
                            </div>
                            <div class="order-details">
                                <div class="order-info">
                                    <div class="info-item">
                                        <div class="info-label">Телефон</div>
                                        <div class="info-value">${order.customer.phone}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Email</div>
                                        <div class="info-value">${order.customer.email}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Адрес</div>
                                        <div class="info-value">${order.customer.address}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Сумма</div>
                                        <div class="info-value">${order.total.toLocaleString()} ₽</div>
                                    </div>
                                    ${telegramInfo ? `
                                    <div class="info-item">
                                        <div class="info-label">Telegram</div>
                                        <div class="info-value">${telegramInfo}</div>
                                    </div>
                                    ` : ''}
                                    ${order.promoCode ? `
                                    <div class="info-item">
                                        <div class="info-label">Промокод</div>
                                        <div class="info-value">${order.promoCode} (скидка ${order.promoDiscount}%)</div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 10px; margin: 15px 0; padding: 10px; background: var(--light); border-radius: 8px;">
                                    <div class="order-status ${statusClass}">${statusText}</div>
                                    <div style="font-size: 13px; color: var(--gray);">
                                        Статус обновлен: ${new Date(order.statusHistory[order.statusHistory.length - 1].date).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                                
                                <div class="order-items">
                                    ${order.items.map(item => `
                                        <div class="order-item">
                                            <img src="${item.image}" alt="${item.name}" class="order-item-image">
                                            <div class="order-item-info">
                                                <div class="order-item-name">${item.name}</div>
                                                <div class="order-item-meta">
                                                    ${item.brand} • ${item.quantity} × ${item.price.toLocaleString()} ₽
                                                    ${item.size ? ` • Размер: ${item.size}` : ''}
                                                </div>
                                            </div>
                                            <div class="order-item-total">${(item.price * item.quantity).toLocaleString()} ₽</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Ошибка загрузки заказов:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="empty-title">Ошибка загрузки</h3>
                        <p class="empty-text">Не удалось загрузить список заказов</p>
                    </div>
                `;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const allOrders = JSON.parse(localStorage.getItem('unicorn_all_orders')) || [];
                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                
                if (orderIndex === -1) {
                    showNotification('Заказ не найден');
                    return;
                }
                
                const oldStatus = allOrders[orderIndex].status;
                allOrders[orderIndex].status = newStatus;
                allOrders[orderIndex].statusHistory.push({
                    status: newStatus,
                    date: new Date().toISOString(),
                    comment: `Статус изменен администратором`
                });
                
                localStorage.setItem('unicorn_all_orders', JSON.stringify(allOrders));
                
                updateUserOrderStatus(orderId, newStatus, allOrders[orderIndex].userId);
                
                await sendStatusUpdateNotification(allOrders[orderIndex], oldStatus, newStatus);
                
                showNotification(`Статус заказа #${orderId} изменен на "${getStatusText(newStatus)}"`);
                
                loadAdminOrders();
                
            } catch (error) {
                console.error('Ошибка обновления статуса:', error);
                showNotification('Ошибка обновления статуса');
            }
        }

        async function sendStatusUpdateNotification(order, oldStatus, newStatus) {
            try {
                const message = `🔄 *ОБНОВЛЕНИЕ СТАТУСА ЗАКАЗА #${order.id}*
                
👤 *Клиент:* ${order.customer.name}
📱 *Телефон:* ${order.customer.phone}
${order.customer.telegramUsername ? `👤 *Telegram:* @${order.customer.telegramUsername}\n` : ''}
📦 *Старый статус:* ${getStatusText(oldStatus)}
✅ *Новый статус:* ${getStatusText(newStatus)}

💰 *Сумма заказа:* ${order.total.toLocaleString()} ₽
📦 *Товаров:* ${order.items.length}
${order.promoCode ? `🎫 *Промокод:* ${order.promoCode} (скидка ${order.promoDiscount}%)\n` : ''}
🕐 *Дата обновления:* ${new Date().toLocaleString('ru-RU')}`;

                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (!response.ok) {
                    console.error('Ошибка отправки в Telegram:', await response.text());
                }
            } catch (error) {
                console.error('Ошибка отправки уведомления:', error);
            }
        }

        function updateUserOrderStatus(orderId, newStatus, userId) {
            try {
                const users = JSON.parse(localStorage.getItem('unicorn_users')) || {};
                
                if (!userId) {
                    for (const uid in users) {
                        const user = users[uid];
                        const orderIndex = user.orders.findIndex(order => order.id === orderId);
                        
                        if (orderIndex !== -1) {
                            userId = uid;
                            break;
                        }
                    }
                }
                
                if (userId && users[userId]) {
                    const user = users[userId];
                    const orderIndex = user.orders.findIndex(order => order.id === orderId);
                    
                    if (orderIndex !== -1) {
                        user.orders[orderIndex].status = newStatus;
                        user.orders[orderIndex].statusHistory.push({
                            status: newStatus,
                            date: new Date().toISOString(),
                            comment: 'Статус обновлен администратором'
                        });
                        
                        localStorage.setItem('unicorn_users', JSON.stringify(users));
                    }
                }
            } catch (error) {
                console.error('Ошибка обновления статуса у пользователя:', error);
            }
        }

        function updateAllOrders() {
            try {
                const allOrders = JSON.parse(localStorage.getItem('unicorn_all_orders')) || [];
                if (allOrders.length === 0) {
                    showNotification('Нет заказов для обновления');
                    return;
                }
                
                let updatedCount = 0;
                const now = new Date();
                
                allOrders.forEach(order => {
                    const orderDate = new Date(order.date);
                    const daysDiff = (now - orderDate) / (1000 * 60 * 60 * 24);
                    
                    if (order.status === 'new' && daysDiff >= 1) {
                        order.status = 'processing';
                        order.statusHistory.push({
                            status: 'processing',
                            date: now.toISOString(),
                            comment: 'Автоматически переведен в обработку'
                        });
                        updatedCount++;
                    } else if (order.status === 'processing' && daysDiff >= 3) {
                        order.status = 'completed';
                        order.statusHistory.push({
                            status: 'completed',
                            date: now.toISOString(),
                            comment: 'Автоматически завершен'
                        });
                        updatedCount++;
                    }
                });
                
                if (updatedCount > 0) {
                    localStorage.setItem('unicorn_all_orders', JSON.stringify(allOrders));
                    showNotification(`Обновлено ${updatedCount} заказов');
                    loadAdminOrders();
                } else {
                    showNotification('Нет заказов для автоматического обновления');
                }
                
            } catch (error) {
                console.error('Ошибка обновления заказов:', error);
                showNotification('Ошибка обновления заказов');
            }
        }

        function updateProfileUI() {
            if (!userData) return;
            
            const avatarText = userData.name ? userData.name.charAt(0).toUpperCase() : '?';
            document.getElementById('profileAvatar').textContent = avatarText;
            document.getElementById('userAvatar').textContent = avatarText;
            document.getElementById('profileName').textContent = userData.name || 'Гость';
            document.getElementById('profilePhone').textContent = userData.phone || 'Не указан';
            
            document.getElementById('statOrders').textContent = userData.orders.length;
            document.getElementById('statFavorites').textContent = userData.favorites.length;
            document.getElementById('statViewed').textContent = userData.viewed.length;
            document.getElementById('statReviews').textContent = userData.reviews || 0;
        }

        function switchPage(pageId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navItems = document.querySelectorAll('.nav-item');
            const pageNavMap = {
                'home': 'Главная',
                'categories': 'Категории',
                'category-page': 'Категории',
                'product-page': 'Главная',
                'favorites': 'Избранное',
                'cart': 'Корзина',
                'profile': 'Профиль',
                'checkout': 'Корзина',
                'admin-orders': 'Профиль'
            };
            
            navItems.forEach(item => {
                if (item.textContent.includes(pageNavMap[pageId])) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                switch(pageId) {
                    case 'home':
                        loadMainCategories();
                        loadPopularProducts();
                        break;
                    case 'categories':
                        loadCategoriesPage();
                        break;
                    case 'favorites':
                        loadFavoritesPage();
                        break;
                    case 'cart':
                        loadCartPage();
                        break;
                    case 'profile':
                        switchProfileTab('stats');
                        break;
                    case 'admin-orders':
                        loadAdminOrders();
                        break;
                }
            }
        }

        function switchProfileTab(tabId) {
            document.querySelectorAll('#profileTabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const activeTab = Array.from(document.querySelectorAll('#profileTabs .tab')).find(tab => 
                tab.textContent.includes(tabId === 'stats' ? 'Статистика' : 
                                        tabId === 'orders' ? 'Заказы' : 'Настройки')
            );
            
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const targetContent = document.getElementById(tabId + 'Tab');
            if (targetContent) {
                targetContent.classList.add('active');
                
                if (tabId === 'orders') {
                    loadUserOrders();
                }
            }
        }

        function loadFavoritesPage() {
            const container = document.getElementById('favoritesContent');
            if (!container) return;
            
            const favoriteProducts = products.filter(p => userData.favorites.includes(p.id));
            
            if (favoriteProducts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="far fa-heart"></i>
                        </div>
                        <h3 class="empty-title">Избранные товары</h3>
                        <p class="empty-text">Нажимайте на сердечки рядом с товарами, чтобы быстро находить то, что вам понравилось.</p>
                        <button class="add-to-cart" onclick="switchPage('home')">
                            <i class="fas fa-store"></i>
                            Перейти к покупкам
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '<div class="favorites-grid" id="favoritesGrid"></div>';
            const grid = document.getElementById('favoritesGrid');
            
            favoriteProducts.forEach(product => {
                const productElement = createProductElement(product);
                grid.appendChild(productElement);
            });
        }

        // ==============================================
        // НОВЫЕ ФУНКЦИИ ДЛЯ РАСШИРЕННОЙ АДМИН-ПАНЕЛИ
        // ==============================================

        function setupAdminPanel() {
            document.getElementById('closeAdmin').onclick = closeAdminPanel;
            document.getElementById('adminOverlay').onclick = closeAdminPanel;
            
            document.getElementById('adminUpdateCategoryImage').onclick = updateCategoryImage;
            document.getElementById('adminAddCategory').onclick = addCategory;
            document.getElementById('adminAddProduct').onclick = addProduct;
            document.getElementById('adminDeleteProductBtn').onclick = deleteProduct;
            document.getElementById('createPromoBtn').onclick = createPromoCode;
            document.getElementById('addReviewBtn').onclick = addReviewFromAdmin;
            document.getElementById('addBulkProducts').onclick = addBulkProducts;
            
            // Назначаем обработчики изменения селектов для управления размерами и характеристиками
            document.getElementById('adminProductManage').addEventListener('change', function() {
                const productId = parseInt(this.value);
                if (productId) {
                    loadProductSizes(productId);
                }
            });
            
            document.getElementById('adminCharProduct').addEventListener('change', function() {
                const productId = parseInt(this.value);
                if (productId) {
                    loadProductCharacteristics(productId);
                }
            });
        }

        function createAdminToggle() {
            const existingToggle = document.querySelector('.admin-toggle');
            if (existingToggle) {
                existingToggle.style.display = isAdmin ? 'flex' : 'none';
                return;
            }
            
            const adminToggle = document.createElement('button');
            adminToggle.className = 'admin-toggle';
            adminToggle.innerHTML = '<i class="fas fa-cog"></i>';
            adminToggle.onclick = openAdminPanel;
            adminToggle.style.display = isAdmin ? 'flex' : 'none';
            document.body.appendChild(adminToggle);
            console.log('Админ-кнопка создана');
        }

        function openAdminPanel() {
            document.getElementById('adminPanel').classList.add('active');
            document.getElementById('adminOverlay').classList.add('active');
            loadAdminData();
            updateCloudStatus();
            console.log('Админ-панель открыта');
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('adminOverlay').classList.remove('active');
            console.log('Админ-панель закрыта');
        }

        // Расширенная функция загрузки данных в админ-панель
        function loadAdminData() {
            // Получаем все селекты
            const categorySelect = document.getElementById('adminCategorySelect');
            const productCategorySelect = document.getElementById('adminProductCategory');
            const deleteProductSelect = document.getElementById('adminDeleteProduct');
            const bulkCategorySelect = document.getElementById('adminBulkCategory');
            const productManageSelect = document.getElementById('adminProductManage');
            const charProductSelect = document.getElementById('adminCharProduct');
            const reviewProductSelect = document.getElementById('adminReviewProduct');
            
            // Очищаем все селекты
            const allSelects = [categorySelect, productCategorySelect, deleteProductSelect, 
                               bulkCategorySelect, productManageSelect, charProductSelect, reviewProductSelect];
            
            allSelects.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">Выберите...</option>';
                }
            });
            
            // Заполняем категориями
            Object.values(categories).forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category.id;
                option1.textContent = category.name;
                categorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category.id;
                option2.textContent = category.name;
                productCategorySelect.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = category.id;
                option3.textContent = category.name;
                bulkCategorySelect.appendChild(option3);
            });
            
            // Заполняем товарами
            products.forEach(product => {
                const option1 = document.createElement('option');
                option1.value = product.id;
                option1.textContent = `${product.name} (${product.price}₽)`;
                deleteProductSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = product.id;
                option2.textContent = `${product.name}`;
                productManageSelect.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = product.id;
                option3.textContent = `${product.name}`;
                charProductSelect.appendChild(option3);
                
                const option4 = document.createElement('option');
                option4.value = product.id;
                option4.textContent = `${product.name}`;
                reviewProductSelect.appendChild(option4);
            });
        }

        // Функция добавления отзыва из админ-панели
        function addReviewFromAdmin() {
            const productId = parseInt(document.getElementById('adminReviewProduct').value);
            const author = document.getElementById('reviewAuthor').value.trim();
            const rating = parseInt(document.getElementById('reviewRating').value);
            const text = document.getElementById('reviewText').value.trim();
            
            if (!productId || !author || !rating || !text) {
                showNotification('Заполните все поля');
                return;
            }
            
            if (rating < 1 || rating > 5) {
                showNotification('Рейтинг должен быть от 1 до 5');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден');
                return;
            }
            
            // Инициализируем массив отзывов если его нет
            if (!product.reviews) {
                product.reviews = [];
            }
            
            // Добавляем отзыв
            const newReview = {
                id: Date.now(),
                author: author,
                rating: rating,
                date: new Date().toISOString(),
                text: text
            };
            
            product.reviews.push(newReview);
            
            // Обновляем количество отзывов и рейтинг
            product.reviewsCount = product.reviews.length;
            
            // Пересчитываем средний рейтинг
            const totalRating = product.reviews.reduce((sum, review) => sum + review.rating, 0);
            product.rating = parseFloat((totalRating / product.reviewsCount).toFixed(1));
            
            // Сохраняем изменения
            saveProducts();
            
            // Очищаем форму
            document.getElementById('reviewAuthor').value = '';
            document.getElementById('reviewRating').value = '';
            document.getElementById('reviewText').value = '';
            
            showNotification(`Отзыв добавлен к товару "${product.name}"`);
        }

        // Функция просмотра отзывов товара
        function viewProductReviews() {
            const productId = parseInt(document.getElementById('adminReviewProduct').value);
            
            if (!productId) {
                showNotification('Выберите товар');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден');
                return;
            }
            
            const reviews = product.reviews || [];
            
            let html = `<h3>Отзывы товара: ${product.name}</h3>`;
            
            if (reviews.length === 0) {
                html += '<p>Отзывов пока нет</p>';
            } else {
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                reviews.forEach(review => {
                    html += `
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong>${review.author}</strong>
                                <div style="color: #FFD700;">
                                    ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">
                                ${new Date(review.date).toLocaleDateString('ru-RU')}
                            </div>
                            <div>${review.text}</div>
                            <button onclick="deleteReview(${productId}, ${review.id})" 
                                    style="background: var(--secondary); color: white; border: none; border-radius: 4px; padding: 4px 8px; margin-top: 5px; cursor: pointer;">
                                Удалить отзыв
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('reviewsList').innerHTML = html;
            document.getElementById('reviewsModal').classList.add('active');
        }

        function deleteReview(productId, reviewId) {
            if (!confirm('Удалить этот отзыв?')) return;
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.reviews) return;
            
            product.reviews = product.reviews.filter(r => r.id !== reviewId);
            product.reviewsCount = product.reviews.length;
            
            // Пересчитываем рейтинг
            if (product.reviews.length > 0) {
                const totalRating = product.reviews.reduce((sum, review) => sum + review.rating, 0);
                product.rating = parseFloat((totalRating / product.reviews.length).toFixed(1));
            } else {
                product.rating = 0;
            }
            
            saveProducts();
            viewProductReviews();
            showNotification('Отзыв удален');
        }

        function closeReviewsModal() {
            document.getElementById('reviewsModal').classList.remove('active');
        }

        // Функция добавления товаров пакетами
        function addBulkProducts() {
            const categoryId = document.getElementById('adminBulkCategory').value;
            const bulkText = document.getElementById('bulkProducts').value.trim();
            
            if (!categoryId || !bulkText) {
                showNotification('Выберите категорию и введите данные');
                return;
            }
            
            if (!categories[categoryId]) {
                showNotification('Категория не найдена');
                return;
            }
            
            try {
                // Парсим JSON (используем одинарные кавычки в примере, заменяем их на двойные)
                const jsonText = bulkText.replace(/'/g, '"');
                const productsData = JSON.parse(jsonText);
                
                if (!Array.isArray(productsData)) {
                    throw new Error('Данные должны быть массивом');
                }
                
                let addedCount = 0;
                let skippedCount = 0;
                
                productsData.forEach(productData => {
                    // Проверяем обязательные поля
                    if (!productData.name || !productData.price) {
                        skippedCount++;
                        return;
                    }
                    
                    // Создаем ID для нового товара
                    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    
                    // Создаем полный объект товара
                    const newProduct = {
                        id: newId,
                        name: productData.name,
                        brand: productData.brand || 'UNICORN',
                        price: parseInt(productData.price),
                        oldPrice: productData.oldPrice ? parseInt(productData.oldPrice) : Math.round(productData.price * 1.2),
                        discount: productData.discount || Math.floor(Math.random() * 30) + 10,
                        category: categoryId,
                        image: productData.image || 'https://images.unsplash.com/photo-1490481651871-ab68de25d43d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                        images: [productData.image || 'https://images.unsplash.com/photo-1490481651871-ab68de25d43d?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80'],
                        description: productData.description || productData.name,
                        characteristics: productData.characteristics || {
                            "Материал": "Хлопок 100%",
                            "Производство": "Россия",
                            "Гарантия": "30 дней"
                        },
                        sizes: productData.sizes || ["S", "M", "L", "XL"],
                        availableSizes: productData.availableSizes || ["S", "M", "L"],
                        materials: productData.materials || "Хлопок 100%",
                        colors: productData.colors || ["Черный", "Белый", "Серый"],
                        rating: 4.5,
                        reviewsCount: 0,
                        inStock: true,
                        deliveryTime: "1-3 дня",
                        warranty: "30 дней",
                        reviews: []
                    };
                    
                    products.push(newProduct);
                    addedCount++;
                });
                
                saveProducts();
                loadAdminData();
                
                showNotification(`Добавлено ${addedCount} товаров. Пропущено: ${skippedCount}`);
                
                // Очищаем текстовое поле
                document.getElementById('bulkProducts').value = '';
                
            } catch (error) {
                console.error('Ошибка парсинга JSON:', error);
                showNotification('Ошибка формата данных. Проверьте синтаксис JSON');
            }
        }

        // Функции для управления размерами товара
        function loadProductSizes(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Показываем секцию управления размерами
            document.getElementById('sizeManagementSection').style.display = 'block';
            
            // Заполняем список доступных размеров
            const sizesList = document.getElementById('availableSizesList');
            const sizes = product.sizes || [];
            const availableSizes = product.availableSizes || [];
            
            let html = '<div class="size-list">';
            
            if (sizes.length === 0) {
                html += '<p>Размеры не указаны</p>';
            } else {
                sizes.forEach(size => {
                    const isAvailable = availableSizes.includes(size);
                    html += `
                        <div class="size-tag" style="background: ${isAvailable ? '#e8f5e9' : '#ffe6e6'}">
                            ${size}
                            <span class="remove-size" onclick="removeSizeFromList(${productId}, '${size}')">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            sizesList.innerHTML = html;
        }

        function addProductSize() {
            const productId = parseInt(document.getElementById('adminProductManage').value);
            const newSize = document.getElementById('newSize').value.trim();
            
            if (!productId || !newSize) {
                showNotification('Выберите товар и введите размер');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден');
                return;
            }
            
            // Инициализируем массивы если их нет
            if (!product.sizes) product.sizes = [];
            if (!product.availableSizes) product.availableSizes = [];
            
            // Проверяем, есть ли уже такой размер
            if (product.sizes.includes(newSize)) {
                showNotification('Этот размер уже существует');
                return;
            }
            
            // Добавляем размер
            product.sizes.push(newSize);
            product.availableSizes.push(newSize);
            
            saveProducts();
            loadProductSizes(productId);
            
            document.getElementById('newSize').value = '';
            showNotification(`Размер "${newSize}" добавлен`);
        }

        function removeProductSize() {
            const productId = parseInt(document.getElementById('adminProductManage').value);
            const sizeToRemove = document.getElementById('removeSize').value.trim();
            
            if (!productId || !sizeToRemove) {
                showNotification('Выберите товар и введите размер');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.sizes) {
                showNotification('Товар не найден или размеры не указаны');
                return;
            }
            
            // Удаляем размер из обоих массивов
            product.sizes = product.sizes.filter(s => s !== sizeToRemove);
            if (product.availableSizes) {
                product.availableSizes = product.availableSizes.filter(s => s !== sizeToRemove);
            }
            
            saveProducts();
            loadProductSizes(productId);
            
            document.getElementById('removeSize').value = '';
            showNotification(`Размер "${sizeToRemove}" удален`);
        }

        function removeSizeFromList(productId, size) {
            if (!confirm(`Удалить размер ${size}?`)) return;
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.sizes) return;
            
            product.sizes = product.sizes.filter(s => s !== size);
            if (product.availableSizes) {
                product.availableSizes = product.availableSizes.filter(s => s !== size);
            }
            
            saveProducts();
            loadProductSizes(productId);
            showNotification(`Размер "${size}" удален`);
        }

        // Функция применения правил для размеров аксессуаров
        function applySizeRules() {
            const hideSizes = document.getElementById('hideSizesForAccessories').checked;
            
            // Обновляем все товары в категории аксессуары
            const accessoryProducts = products.filter(p => p.category === 'accessories');
            
            accessoryProducts.forEach(product => {
                if (hideSizes) {
                    // Удаляем размеры у аксессуаров
                    product.sizes = [];
                    product.availableSizes = [];
                } else {
                    // Добавляем стандартные размеры если их нет
                    if (!product.sizes || product.sizes.length === 0) {
                        product.sizes = ['OSFA', 'Универсальный'];
                        product.availableSizes = ['OSFA', 'Универсальный'];
                    }
                }
            });
            
            saveProducts();
            
            // Перезагружаем данные если нужно
            const selectedProductId = parseInt(document.getElementById('adminProductManage').value);
            if (selectedProductId) {
                const selectedProduct = products.find(p => p.id === selectedProductId);
                if (selectedProduct && selectedProduct.category === 'accessories') {
                    loadProductSizes(selectedProductId);
                }
            }
            
            showNotification(`Правило для аксессуаров ${hideSizes ? 'применено' : 'отключено'}`);
        }

        // Функции для управления характеристиками
        function loadProductCharacteristics(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Показываем секцию управления характеристиками
            document.getElementById('characteristicManagement').style.display = 'block';
            
            // Заполняем список характеристик
            const charList = document.getElementById('characteristicsList');
            const characteristics = product.characteristics || {};
            
            let html = '<div class="char-list">';
            
            if (Object.keys(characteristics).length === 0) {
                html += '<p>Характеристики не указаны</p>';
            } else {
                Object.entries(characteristics).forEach(([key, value]) => {
                    html += `
                        <div class="char-tag">
                            <div>
                                <strong>${key}:</strong> ${value}
                            </div>
                            <button onclick="removeCharFromList(${productId}, '${key}')" 
                                    style="background: var(--secondary); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">
                                Удалить
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            charList.innerHTML = html;
        }

        function addCharacteristic() {
            const productId = parseInt(document.getElementById('adminCharProduct').value);
            const charName = document.getElementById('charName').value.trim();
            const charValue = document.getElementById('charValue').value.trim();
            
            if (!productId || !charName || !charValue) {
                showNotification('Заполните все поля');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Товар не найден');
                return;
            }
            
            // Инициализируем характеристики если их нет
            if (!product.characteristics) {
                product.characteristics = {};
            }
            
            // Добавляем или обновляем характеристику
            product.characteristics[charName] = charValue;
            
            // Сохраняем изменения
            saveProducts();
            loadProductCharacteristics(productId);
            
            // Очищаем поля
            document.getElementById('charName').value = '';
            document.getElementById('charValue').value = '';
            
            showNotification(`Характеристика "${charName}" добавлена`);
        }

        function removeCharacteristic() {
            const productId = parseInt(document.getElementById('adminCharProduct').value);
            const charName = document.getElementById('removeCharName').value.trim();
            
            if (!productId || !charName) {
                showNotification('Заполните поле');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.characteristics) {
                showNotification('Характеристики не найдены');
                return;
            }
            
            if (!product.characteristics[charName]) {
                showNotification('Характеристика не найдена');
                return;
            }
            
            // Удаляем характеристику
            delete product.characteristics[charName];
            
            saveProducts();
            loadProductCharacteristics(productId);
            
            document.getElementById('removeCharName').value = '';
            showNotification(`Характеристика "${charName}" удалена`);
        }

        function removeCharFromList(productId, charName) {
            if (!confirm(`Удалить характеристику "${charName}"?`)) return;
            
            const product = products.find(p => p.id === productId);
            if (!product || !product.characteristics) return;
            
            delete product.characteristics[charName];
            
            saveProducts();
            loadProductCharacteristics(productId);
            showNotification(`Характеристика "${charName}" удалена`);
        }

        function saveCharacteristics() {
            showNotification('Характеристики сохранены автоматически при изменении');
        }

        // Существующие функции админ-панели (остаются без изменений)
        function updateCategoryImage() {
            const categoryId = document.getElementById('adminCategorySelect').value;
            const imageUrl = document.getElementById('adminCategoryImage').value.trim();
            
            if (!categoryId || !imageUrl) {
                showNotification('Выберите категорию и введите URL картинки');
                return;
            }
            
            if (!categories[categoryId]) {
                showNotification('Категория не найдена');
                return;
            }
            
            categories[categoryId].image = imageUrl;
            saveCategories();
            
            showNotification(`Картинка категории "${categories[categoryId].name}" обновлена`);
            
            loadMainCategories();
            loadCategoriesPage();
            loadAdminData();
            
            document.getElementById('adminCategoryImage').value = '';
        }

        function addCategory() {
            const name = document.getElementById('adminNewCategoryName').value.trim();
            const imageUrl = document.getElementById('adminNewCategoryImage').value.trim();
            
            if (!name || !imageUrl) {
                showNotification('Введите название и URL картинки');
                return;
            }
            
            const categoryId = name.toLowerCase()
                .replace(/[^a-z0-9а-яё]/gi, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
            
            if (categories[categoryId]) {
                showNotification('Категория с таким названием уже существует');
                return;
            }
            
            categories[categoryId] = {
                id: categoryId,
                name: name,
                image: imageUrl,
                description: name
            };
            
            saveCategories();
            
            showNotification(`Категория "${name}" добавлена`);
            
            loadMainCategories();
            loadCategoriesPage();
            loadAdminData();
            
            document.getElementById('adminNewCategoryName').value = '';
            document.getElementById('adminNewCategoryImage').value = '';
        }

        function addProduct() {
            const name = document.getElementById('adminProductName').value.trim();
            const price = parseInt(document.getElementById('adminProductPrice').value);
            const categoryId = document.getElementById('adminProductCategory').value;
            const imageUrl = document.getElementById('adminProductImage').value.trim();
            const description = document.getElementById('adminProductDescription').value.trim();
            
            if (!name || !price || !categoryId || !imageUrl) {
                showNotification('Заполните все обязательные поля');
                return;
            }
            
            if (!categories[categoryId]) {
                showNotification('Выбранная категория не существует');
                return;
            }
            
            const productId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
            
            const newProduct = {
                id: productId,
                name: name,
                brand: 'UNICORN',
                price: price,
                oldPrice: Math.round(price * 1.2),
                discount: Math.floor(Math.random() * 30) + 10,
                category: categoryId,
                image: imageUrl,
                images: [imageUrl],
                description: description || name,
                characteristics: {
                    "Материал": "Хлопок 100%",
                    "Производство": "Россия",
                    "Гарантия": "30 дней"
                },
                sizes: ["S", "M", "L", "XL"],
                availableSizes: ["S", "M", "L"],
                materials: "Хлопок 100%",
                colors: ["Черный", "Белый", "Серый"],
                rating: 4.5,
                reviewsCount: 0,
                inStock: true,
                deliveryTime: "1-3 дня",
                warranty: "30 дней",
                reviews: []
            };
            
            products.push(newProduct);
            saveProducts();
            
            showNotification(`Товар "${name}" добавлен (ID: ${productId})`);
            
            document.getElementById('adminProductName').value = '';
            document.getElementById('adminProductPrice').value = '';
            document.getElementById('adminProductCategory').value = '';
            document.getElementById('adminProductImage').value = '';
            document.getElementById('adminProductDescription').value = '';
            
            loadAdminData();
        }

        function deleteProduct() {
            const productId = parseInt(document.getElementById('adminDeleteProduct').value);
            
            if (!productId) {
                showNotification('Выберите товар для удаления');
                return;
            }
            
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showNotification('Товар не найден');
                return;
            }
            
            const productName = products[productIndex].name;
            products.splice(productIndex, 1);
            saveProducts();
            
            const users = JSON.parse(localStorage.getItem('unicorn_users')) || {};
            Object.values(users).forEach(user => {
                user.favorites = user.favorites.filter(favId => favId !== productId);
                user.cart = user.cart.filter(item => item.id !== productId);
            });
            localStorage.setItem('unicorn_users', JSON.stringify(users));
            
            if (userData) {
                userData.favorites = userData.favorites.filter(favId => favId !== productId);
                userData.cart = userData.cart.filter(item => item.id !== productId);
                saveUserData();
                updateFavoritesBadge();
                updateCartBadge();
            }
            
            showNotification(`Товар "${productName}" удален`);
            
            loadAdminData();
            
            const activePage = document.querySelector('.page.active').id;
            if (activePage === 'home') loadPopularProducts();
            if (activePage === 'favorites') loadFavoritesPage();
            if (activePage === 'cart') loadCartPage();
            if (activePage === 'product-page') {
                if (currentProductId === productId) {
                    goBackFromProduct();
                }
            }
        }

        function createPromoCode() {
            const code = document.getElementById('promoCode').value.trim().toUpperCase();
            const discount = parseInt(document.getElementById('promoDiscount').value);
            const maxUses = parseInt(document.getElementById('promoMaxUses').value) || null;
            const expiry = document.getElementById('promoExpiry').value;
            
            if (!code || !discount || discount < 1 || discount > 100) {
                showNotification('Введите корректный код и скидку (1-100%)');
                return;
            }
            
            const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
            if (promoCodes.some(p => p.code === code)) {
                showNotification('Промокод с таким кодом уже существует');
                return;
            }
            
            const promo = {
                code: code,
                discount: discount,
                maxUses: maxUses,
                expiry: expiry || null,
                created: new Date().toISOString(),
                used: 0,
                usedBy: []
            };
            
            promoCodes.push(promo);
            localStorage.setItem('unicorn_promocodes', JSON.stringify(promoCodes));
            
            showNotification(`Промокод "${code}" создан! Скидка: ${discount}%`);
            
            document.getElementById('promoCode').value = '';
            document.getElementById('promoDiscount').value = '';
            document.getElementById('promoMaxUses').value = '';
            document.getElementById('promoExpiry').value = '';
        }

        function viewPromoCodes() {
            const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
            
            if (promoCodes.length === 0) {
                document.getElementById('promoCodesList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-ticket-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Промокодов нет</h3>
                        <p>Создайте свой первый промокод</p>
                    </div>
                `;
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                promoCodes.forEach(promo => {
                    const created = new Date(promo.created);
                    const expiry = promo.expiry ? new Date(promo.expiry) : null;
                    const isExpired = expiry && expiry < new Date();
                    
                    html += `
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: ${isExpired ? '#ffe6e6' : '#e6ffe6'}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong style="font-size: 16px;">${promo.code}</strong>
                                    <span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">
                                        ${promo.discount}% скидка
                                    </span>
                                </div>
                                <button onclick="deletePromoCode('${promo.code}')" style="background: var(--secondary); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">
                                    Удалить
                                </button>
                            </div>
                            <div style="font-size: 13px; color: var(--gray);">
                                <div>Создан: ${created.toLocaleDateString('ru-RU')}</div>
                                <div>Использован: ${promo.used || 0} раз ${promo.maxUses ? `из ${promo.maxUses}` : ''}</div>
                                ${expiry ? `<div>Действует до: ${expiry.toLocaleDateString('ru-RU')} ${isExpired ? ' (ИСТЕК)' : ''}</div>` : ''}
                                ${promo.usedBy && promo.usedBy.length > 0 ? `<div>Использовали: ${promo.usedBy.length} пользователей</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('promoCodesList').innerHTML = html;
            }
            
            document.getElementById('promoCodesModal').classList.add('active');
        }

        function deletePromoCode(code) {
            if (confirm(`Удалить промокод "${code}"?`)) {
                const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
                const filtered = promoCodes.filter(p => p.code !== code);
                localStorage.setItem('unicorn_promocodes', JSON.stringify(filtered));
                showNotification(`Промокод "${code}" удален`);
                viewPromoCodes();
            }
        }

        function clearExpiredPromos() {
            const promoCodes = JSON.parse(localStorage.getItem('unicorn_promocodes')) || [];
            const now = new Date();
            const validPromos = promoCodes.filter(promo => {
                if (!promo.expiry) return true;
                return new Date(promo.expiry) > now;
            });
            
            if (validPromos.length === promoCodes.length) {
                showNotification('Нет истекших промокодов');
                return;
            }
            
            localStorage.setItem('unicorn_promocodes', JSON.stringify(validPromos));
            showNotification(`Удалено ${promoCodes.length - validPromos.length} истекших промокодов`);
            viewPromoCodes();
        }

        function closePromoCodesModal() {
            document.getElementById('promoCodesModal').classList.remove('active');
        }

        function viewAllUsers() {
            const users = JSON.parse(localStorage.getItem('unicorn_users')) || {};
            
            if (Object.keys(users).length === 0) {
                document.getElementById('usersList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <h3>Пользователей нет</h3>
                    </div>
                `;
            } else {
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                Object.values(users).forEach(user => {
                    const created = new Date(user.createdAt);
                    const lastActive = new Date(user.lastActive);
                    
                    html += `
                        <div style="border: 1px solid var(--border); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <strong style="font-size: 16px;">${user.name}</strong>
                                    <div style="font-size: 12px; color: var(--gray); margin-top: 2px;">ID: ${user.id}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: var(--gray);">${user.telegramUsername ? `@${user.telegramUsername}` : ''}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px; color: var(--gray);">
                                <div>
                                    <div>Заказов: ${user.orders.length}</div>
                                    <div>Избранное: ${user.favorites.length}</div>
                                </div>
                                <div>
                                    <div>Создан: ${created.toLocaleDateString('ru-RU')}</div>
                                    <div>Был активен: ${lastActive.toLocaleDateString('ru-RU')}</div>
                                </div>
                            </div>
                            ${user.phone ? `<div style="margin-top: 5px;">📱 ${user.phone}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('usersList').innerHTML = html;
            }
            
            document.getElementById('usersModal').classList.add('active');
        }

        function closeUsersModal() {
            document.getElementById('usersModal').classList.remove('active');
        }

        function exportData() {
            const data = {
                categories: categories,
                products: products,
                users: JSON.parse(localStorage.getItem('unicorn_users')) || {},
                orders: JSON.parse(localStorage.getItem('unicorn_all_orders')) || [],
                promoCodes: JSON.parse(localStorage.getItem('unicorn_promocodes')) || [],
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `unicorn_backup_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Данные экспортированы');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.categories || !data.products) {
                        throw new Error('Неверный формат файла');
                    }
                    
                    if (confirm('Внимание! Это заменит все текущие данные. Продолжить?')) {
                        categories = data.categories;
                        products = data.products;
                        
                        if (data.users) {
                            localStorage.setItem('unicorn_users', JSON.stringify(data.users));
                        }
                        
                        if (data.orders) {
                            localStorage.setItem('unicorn_all_orders', JSON.stringify(data.orders));
                        }
                        
                        if (data.promoCodes) {
                            localStorage.setItem('unicorn_promocodes', JSON.stringify(data.promoCodes));
                        }
                        
                        saveCategories();
                        saveProducts();
                        
                        showNotification('Данные импортированы');
                        
                        loadMainCategories();
                        loadPopularProducts();
                        loadAdminData();
                        
                        if (userData) {
                            userData = getUserData(currentUserId);
                            updateProfileUI();
                            updateCartBadge();
                            updateFavoritesBadge();
                        }
                    }
                } catch (error) {
                    console.error('Ошибка импорта:', error);
                    showNotification('Ошибка импорта данных');
                }
            };
            
            input.click();
        }

        function resetData() {
            if (confirm('ВНИМАНИЕ! Это удалит ВСЕ данные (категории, товары, пользователей, заказы). Продолжить?')) {
                const currentSession = {
                    userId: currentUserId,
                    telegramUsername: telegramUsername,
                    telegramFirstName: telegramFirstName,
                    telegramLastName: telegramLastName,
                    telegramUserId: telegramUserId,
                    cart: userData.cart,
                    favorites: userData.favorites
                };
                
                localStorage.clear();
                
                localStorage.setItem('unicorn_session', JSON.stringify(currentSession));
                
                categories = JSON.parse(JSON.stringify(defaultCategories));
                products = JSON.parse(JSON.stringify(defaultProducts));
                
                localStorage.setItem('unicorn_categories', JSON.stringify(categories));
                localStorage.setItem('unicorn_products', JSON.stringify(products));
                
                if (currentUserId) {
                    userData = createNewUserData(currentUserId);
                    userData.cart = currentSession.cart || [];
                    userData.favorites = currentSession.favorites || [];
                    saveUserData();
                }
                
                showNotification('Все данные сброшены, ваша корзина сохранена');
                
                loadMainCategories();
                loadPopularProducts();
                loadAdminData();
                updateProfileUI();
                updateCartBadge();
                updateFavoritesBadge();
            }
        }

        function exportUserData() {
            const userDataToExport = {
                ...userData,
                password: undefined
            };
            
            const dataStr = JSON.stringify(userDataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `unicorn_user_${currentUserId}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Ваши данные экспортированы');
        }

        function clearUserData() {
            if (confirm('Вы уверены? Это удалит ваши избранное, корзину и историю просмотров.')) {
                userData.favorites = [];
                userData.cart = [];
                userData.viewed = [];
                activePromoCode = null;
                saveUserData();
                
                updateFavoritesBadge();
                updateCartBadge();
                updateProfileUI();
                
                showNotification('Ваши данные очищены');
            }
        }

        function changeUserName() {
            const newName = prompt('Введите новое имя:', userData.name);
            if (newName && newName.trim()) {
                userData.name = newName.trim();
                saveUserData();
                updateProfileUI();
                showNotification('Имя изменено');
            }
        }

        // Modal functions
        function openPhoneModal() {
            const phone = prompt('Введите ваш номер телефона:', userData.phone || '');
            if (phone !== null) {
                userData.phone = phone.trim();
                saveUserData();
                updateProfileUI();
                showNotification('Номер телефона сохранен');
            }
        }

        function openAddressModal() {
            const address = prompt('Введите ваш адрес:', userData.address || '');
            if (address !== null) {
                userData.address = address.trim();
                saveUserData();
                updateProfileUI();
                showNotification('Адрес сохранен');
            }
        }

        function openCustomsModal() {
            showNotification('Функция в разработке');
        }

        function openInviteModal() {
            const inviteLink = `${window.location.origin}${window.location.pathname}#profile-${encodeURIComponent(currentUserId)}`;
            if (navigator.share) {
                navigator.share({
                    title: 'UNICORN Shop',
                    text: 'Привет! Заходи в мой магазин одежды и обуви UNICORN!',
                    url: inviteLink
                }).catch(() => {
                    copyToClipboard(inviteLink);
                });
            } else {
                copyToClipboard(inviteLink);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => showNotification('Ссылка скопирована в буфер обмена'))
                .catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification('Ссылка скопирована в буфер обмена');
                });
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // Инициализация Telegram Web App
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                tg.expand();
                
                const user = tg.initDataUnsafe.user;
                if (user) {
                    console.log('Telegram данные получены:', user);
                    
                    if (user.username) {
                        telegramUsername = user.username;
                        localStorage.setItem('unicorn_telegramUsername', user.username);
                    }
                    if (user.first_name) {
                        telegramFirstName = user.first_name;
                        localStorage.setItem('unicorn_telegramFirstName', user.first_name);
                    }
                    if (user.last_name) {
                        telegramLastName = user.last_name;
                        localStorage.setItem('unicorn_telegramLastName', user.last_name);
                    }
                    if (user.id) {
                        telegramUserId = user.id.toString();
                        localStorage.setItem('unicorn_telegramId', telegramUserId);
                    }
                    
                    if (telegramUserId) {
                        window.location.hash = `profile-${telegramUserId}`;
                    }
                    
                    if (isInitialized) {
                        userData = getUserData(currentUserId);
                        
                        updateProfileUI();
                        updateCartBadge();
                        updateFavoritesBadge();
                        
                        const wasAdmin = isAdmin;
                        isAdmin = checkAdminRights();
                        
                        if (wasAdmin !== isAdmin) {
                            checkAndShowAdminButton();
                            if (isAdmin) {
                                showNotification('✅ Вы вошли как администратор');
                            }
                        }
                        
                        saveUserSession();
                    }
                }
                
                console.log('Telegram Web App инициализирован (тема не изменяется)');
                
                if (user && (user.id.toString() === ADMIN_USER_ID || user.username === 'barizhka')) {
                    isAdmin = true;
                    checkAndShowAdminButton();
                    console.log('Telegram администратор обнаружен');
                }
            } else {
                console.log('Telegram Web App не обнаружен, работаем в обычном режиме');
                
                if (currentUserId === ADMIN_USER_ID) {
                    isAdmin = true;
                    checkAndShowAdminButton();
                    console.log('Администратор по ID активирован в режиме отладки');
                }
            }
        }

        if (window.Telegram && window.Telegram.WebApp) {
            initTelegramWebApp();
        } else {
            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-web-app.js';
            script.onload = function() {
                console.log('Telegram Web App скрипт загружен');
                initTelegramWebApp();
            };
            script.onerror = function() {
                console.log('Не удалось загрузить Telegram Web App скрипт');
            };
            document.head.appendChild(script);
        }

        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><rect width="400" height="400" fill="%238A2BE2"/><text x="200" y="200" font-family="Inter" font-size="24" fill="white" text-anchor="middle" dy=".3em">Изображение</text></svg>';
                e.target.onerror = null;
            }
        }, true);

        window.addEventListener('beforeunload', function() {
            saveUserSession();
        });
    </script>
</body>
</html>
